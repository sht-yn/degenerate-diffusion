{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"blackjax_nuts_usage/","title":"BlackJax","text":""},{"location":"blackjax_nuts_usage/#blackjax-nuts","title":"BlackJAX \u3092\u4f7f\u3063\u305f NUTS \u30b5\u30f3\u30d7\u30e9\u30fc\u69cb\u7bc9\u30ac\u30a4\u30c9","text":"<p>\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001<code>src/degenerate_diffusion/estimation/parameter_estimator_new.py</code> \u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b <code>build_b</code> \u95a2\u6570\u3092\u4f8b\u306b\u3001BlackJAX \u306e NUTS \u30b5\u30f3\u30d7\u30e9\u30fc\u3092\u3069\u306e\u3088\u3046\u306b\u7d44\u307f\u7acb\u3066\u3066\u3044\u308b\u304b\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002</p>"},{"location":"blackjax_nuts_usage/#_1","title":"\u6982\u8981","text":"<p><code>build_b</code> \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u95a2\u6570\u3092\u8fd4\u3057\u307e\u3059\u3002</p> <pre><code>(theta0: jax.Array, key: jax.Array, aux: Any) -&gt; jax.Array\n</code></pre> <ul> <li><code>theta0</code>: \u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u958b\u59cb\u70b9\uff08\u30d1\u30e9\u30e1\u30fc\u30bf\u521d\u671f\u5024\uff09</li> <li><code>key</code>: <code>jax.random.PRNGKey</code>\uff08\u4e71\u6570\u751f\u6210\u306e\u5143\uff09</li> <li><code>aux</code>: \u30ed\u30b0\u78ba\u7387\u8a08\u7b97\u3067\u5fc5\u8981\u306a\u88dc\u52a9\u30c7\u30fc\u30bf\uff08PyTree\uff09</li> </ul> <p>\u8fd4\u308a\u5024\u306f\u3001\u30d6\u30e9\u30c3\u30af\u30dc\u30c3\u30af\u30b9\u5316\u3055\u308c\u305f NUTS \u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u304b\u3089\u5f97\u305f\u4e8b\u5f8c\u5206\u5e03\u30b5\u30f3\u30d7\u30eb\u306e\u5e73\u5747\u3067\u3059\u3002\u95a2\u6570\u5168\u4f53\u306f <code>jax.jit</code> \u3067 JIT \u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u3001JAX \u4e92\u63db\u306e\u7d14\u95a2\u6570\u3068\u3057\u3066\u5229\u7528\u3067\u304d\u307e\u3059\u3002</p>"},{"location":"blackjax_nuts_usage/#blackjax","title":"BlackJAX \u30ab\u30fc\u30cd\u30eb\u306e\u69cb\u7bc9","text":"<pre><code>nuts = blackjax.nuts(logprob, step_size=step_size, inverse_mass_matrix=inv_mass)\nstate0 = nuts.init(theta0)\n</code></pre> <ol> <li><code>logprob</code>: <code>theta -&gt; log p(theta | aux)</code> \u3092\u8fd4\u3059\u95a2\u6570\u3002<code>build_b</code> \u5185\u3067\u306f\u3001\u30e6\u30fc\u30b6\u30fc\u304c\u6e21\u3057\u305f <code>logprob_fn(theta, aux)</code> \u3092 <code>jnp.asarray</code> \u3067\u5305\u307f\u3001JAX \u306e\u81ea\u52d5\u5fae\u5206\u304c\u6271\u3048\u308b\u5f62\u306b\u6574\u3048\u307e\u3059\u3002</li> <li><code>step_size</code>: NUTS \u306e\u30b9\u30c6\u30c3\u30d7\u30b5\u30a4\u30ba\uff08\u30ea\u30fc\u30d7\u30d5\u30ed\u30c3\u30b01\u30b9\u30c6\u30c3\u30d7\u3042\u305f\u308a\u306e\u9577\u3055\uff09\u3002</li> <li><code>inverse_mass_matrix</code>: \u30cf\u30df\u30eb\u30c8\u30cb\u30a2\u30f3\u30e2\u30f3\u30c6\u30ab\u30eb\u30ed\u306b\u304a\u3051\u308b\u9006\u8cea\u91cf\u884c\u5217\u3002\u672a\u6307\u5b9a\u306a\u3089 <code>theta0</code> \u3068\u540c\u5f62\u72b6\u306e <code>1</code> \u3092\u4f7f\u3044\u3001\u5404\u6b21\u5143\u3092\u540c\u3058\u30b9\u30b1\u30fc\u30eb\u3068\u3057\u3066\u6271\u3044\u307e\u3059\u3002\u5404\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u30b9\u30b1\u30fc\u30eb\u8abf\u6574\u3084\u76f8\u95a2\u306e\u53d6\u308a\u8fbc\u307f\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u30e6\u30fc\u30b6\u30fc\u304c\u9069\u5207\u306a\u5024\u3092\u6e21\u3057\u307e\u3059\u3002</li> <li><code>nuts.init(theta0)</code>: \u521d\u671f\u72b6\u614b\u3092\u69cb\u7bc9\u3002\u3053\u3053\u3067 <code>theta0</code> \u3092\u51fa\u767a\u70b9\u3068\u3059\u308b\u30cf\u30df\u30eb\u30c8\u30cb\u30a2\u30f3\u8ecc\u9053\u8a08\u7b97\u306e\u6e96\u5099\u304c\u6574\u3044\u307e\u3059\u3002</li> </ol>"},{"location":"blackjax_nuts_usage/#1-one_step","title":"1 \u30b9\u30c6\u30c3\u30d7\u306e\u66f4\u65b0 (<code>one_step</code>)","text":"<pre><code>def one_step(state, _):\n    st, k_local = state\n    k_local, k_use = jax.random.split(k_local)\n    st_new, _info = nuts.step(k_use, st)\n    return (st_new, k_local), st_new.position\n</code></pre> <ul> <li>\u4e71\u6570\u30ad\u30fc\u3092 <code>split</code> \u3057\u3001\u4e00\u5ea6\u304d\u308a\u306e\u4e71\u6570\u3092\u62bd\u51fa\u3002</li> <li><code>nuts.step</code> \u306f\u6b21\u306e NUTS \u72b6\u614b (<code>st_new</code>) \u3068\u30e1\u30bf\u60c5\u5831\uff08\u30b5\u30f3\u30d7\u30eb\u63a1\u629e\u7387\u306a\u3069\uff09\u3092\u8fd4\u3057\u307e\u3059\u3002</li> <li><code>st_new.position</code> \u304c\u65b0\u3057\u3044\u30d1\u30e9\u30e1\u30fc\u30bf\u30b5\u30f3\u30d7\u30eb\u3067\u3059\u3002</li> </ul>"},{"location":"blackjax_nuts_usage/#jaxlaxscan","title":"\u30a6\u30a9\u30fc\u30e0\u30a2\u30c3\u30d7 (<code>jax.lax.scan</code>)","text":"<pre><code>(state_warm_end, key_after), _ = jax.lax.scan(\n    one_step, (state0, key), jnp.arange(num_warmup_i)\n)\n</code></pre> <ul> <li>\u30a6\u30a9\u30fc\u30e0\u30a2\u30c3\u30d7\u56de\u6570 (<code>num_warmup</code>) \u5206\u3060\u3051 <code>one_step</code> \u3092\u7e70\u308a\u8fd4\u3057\u3001   \u30b5\u30f3\u30d7\u30e9\u30fc\u3092\u4e8b\u5f8c\u5206\u5e03\u306e\u9ad8\u5bc6\u5ea6\u9818\u57df\u3078\u79fb\u52d5\u3055\u305b\u307e\u3059\u3002</li> <li><code>scan</code> \u3092\u4f7f\u3046\u3053\u3068\u3067\u3001JAX \u304c\u30eb\u30fc\u30d7\u3092\u9010\u6b21\u51e6\u7406\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001   \u8a08\u7b97\u30b0\u30e9\u30d5\u3068\u3057\u3066\u6700\u9069\u5316\u30fb\u4e26\u5217\u5316\u3067\u304d\u307e\u3059\u3002</li> </ul>"},{"location":"blackjax_nuts_usage/#_2","title":"\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3068\u30b7\u30f3\u30cb\u30f3\u30b0","text":"<pre><code>def sample_body(carry, _):\n    st, k_local = carry\n\n    def do_thin(_, c):\n        st_cur, k_cur = c\n        k_cur, k_use = jax.random.split(k_cur)\n        st_new, _ = nuts.step(k_use, st_cur)\n        return st_new, k_cur\n\n    st_thin, k_thin = jax.lax.fori_loop(0, thin_i - 1, do_thin, (st, k_local))\n    (st_new, k_new), sample = one_step((st_thin, k_thin), jnp.asarray(0))\n    return (st_new, k_new), sample\n\n(_, _), samples = jax.lax.scan(\n    sample_body, (state_warm_end, key_after), jnp.arange(num_samples_i)\n)\n</code></pre> <ul> <li><code>thin &gt; 1</code> \u306e\u5834\u5408\u3001<code>fori_loop</code> \u3067 <code>thin-1</code> \u56de\u3060\u3051\u30b5\u30f3\u30d7\u30e9\u30fc\u3092\u52d5\u304b\u3057\u3001   \u9023\u7d9a\u30b5\u30f3\u30d7\u30eb\u9593\u306e\u81ea\u5df1\u76f8\u95a2\u3092\u4e0b\u3052\u307e\u3059\u3002</li> <li><code>one_step</code> \u3092\u547c\u3093\u3067\u5b9f\u969b\u306e\u4fdd\u5b58\u30b5\u30f3\u30d7\u30eb\u3092\u53d6\u5f97\u3002</li> <li><code>scan</code> \u3067 <code>num_samples</code> \u500b\u306e\u30b5\u30f3\u30d7\u30eb\u5217\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002</li> </ul>"},{"location":"blackjax_nuts_usage/#_3","title":"\u8fd4\u308a\u5024","text":"<pre><code>return jnp.mean(samples, axis=0)\n</code></pre> <ul> <li>\u5f97\u3089\u308c\u305f\u30b5\u30f3\u30d7\u30eb\u306e\u7b97\u8853\u5e73\u5747\u3092\u8fd4\u3057\u307e\u3059\u3002\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u3001\u4e2d\u592e\u5024\u3084\u5206\u6563\u306a\u3069\u5225\u306e\u7d71\u8a08\u91cf\u3092\u8a08\u7b97\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3067\u304d\u307e\u3059\u3002</li> </ul>"},{"location":"blackjax_nuts_usage/#_4","title":"\u4f7f\u3044\u65b9\u306e\u4f8b","text":"<pre><code>from jax import random\nimport jax.numpy as jnp\n\n# \u30ed\u30b0\u78ba\u7387\u95a2\u6570\u306e\u4f8b\uff08\u591a\u5909\u91cf\u6b63\u898f\uff09\ndef logprob(theta, aux):\n    mean, cov_inv = aux\n    diff = theta - mean\n    return -0.5 * diff.T @ cov_inv @ diff\n\nkey = random.key(0)\ntheta0 = jnp.zeros(3)\nmean = jnp.array([1.0, 0.0, -1.0])\ncov_inv = jnp.eye(3)\naux = (mean, cov_inv)\n\nsampler = build_b(logprob, step_size=0.1, num_warmup=200, num_samples=1000)\ntheta_mean = sampler(theta0, key, aux)\n</code></pre> <ul> <li>\u3053\u3053\u3067\u306f\u5358\u7d14\u306a\u6b63\u898f\u5206\u5e03\u3092\u4f8b\u306b\u3057\u307e\u3057\u305f\u304c\u3001<code>logprob</code> \u306e\u4e2d\u8eab\u3092\u5dee\u3057\u66ff\u3048\u308b\u3060\u3051\u3067\u8907\u96d1\u306a\u30e2\u30c7\u30eb\u306b\u3082\u9069\u7528\u3067\u304d\u307e\u3059\u3002</li> <li>\u5b9f\u884c\u74b0\u5883\u304c GPU/TPU \u306e\u5834\u5408\u3082 <code>jax.jit</code> \u306b\u3088\u3063\u3066\u540c\u3058\u30b3\u30fc\u30c9\u3067\u9ad8\u901f\u306b\u52d5\u4f5c\u3057\u307e\u3059\u3002</li> </ul>"},{"location":"blackjax_nuts_usage/#_5","title":"\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306e\u30d2\u30f3\u30c8","text":"<ul> <li><code>step_size</code>: \u5927\u304d\u3059\u304e\u308b\u3068\u53d7\u5bb9\u7387\u304c\u4e0b\u304c\u308a\u3001\u5c0f\u3055\u3059\u304e\u308b\u3068\u63a2\u7d22\u52b9\u7387\u304c\u843d\u3061\u307e\u3059\u3002<code>build_b</code> \u306f\u56fa\u5b9a\u5024\u3092\u53d7\u3051\u53d6\u308b\u8a2d\u8a08\u3067\u3059\u304c\u3001\u5916\u90e8\u3067\u9069\u5fdc\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\uff08\u4f8b: step size tuning\uff09\u3092\u884c\u3063\u3066\u7d50\u679c\u3092\u6e21\u3059\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002</li> <li><code>inverse_mass_matrix</code>: \u4e8b\u524d\u306b\u6700\u9069\u5316\u3084\u904e\u53bb\u306e\u30b5\u30f3\u30d7\u30eb\u304b\u3089\u63a8\u5b9a\u3057\u305f\u5171\u5206\u6563\u60c5\u5831\u3092\u4f7f\u3046\u3068\u3001\u53ce\u675f\u304c\u5927\u5e45\u306b\u6539\u5584\u3059\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002BlackJAX \u306f\u5bfe\u89d2\u884c\u5217\u3068\u4e00\u822c\u884c\u5217\u306e\u3069\u3061\u3089\u306b\u3082\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002</li> <li><code>thin</code>: \u81ea\u5df1\u76f8\u95a2\u304c\u6c17\u306b\u306a\u308b\u5834\u5408\u306e\u307f\u5927\u304d\u3081\u306b\u8a2d\u5b9a\u3057\u3001\u57fa\u672c\u306f <code>1</code>\uff08\u9593\u5f15\u304d\u306a\u3057\uff09\u304c\u63a8\u5968\u3067\u3059\u3002</li> <li><code>num_warmup</code> \u3068 <code>num_samples</code>: \u30e2\u30c7\u30eb\u306e\u8907\u96d1\u3055\u306b\u5fdc\u3058\u3066\u8abf\u6574\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30a6\u30a9\u30fc\u30e0\u30a2\u30c3\u30d7\u304c\u4e0d\u5341\u5206\u3060\u3068\u53ce\u675f\u305b\u305a\u3001\u30b5\u30f3\u30d7\u30eb\u6570\u304c\u5c11\u306a\u3044\u3068\u4e8b\u5f8c\u5e73\u5747\u306e\u63a8\u5b9a\u304c\u4e0d\u5b89\u5b9a\u306b\u306a\u308a\u307e\u3059\u3002</li> </ul> <p><code>build_b</code> \u306f BlackJAX \u306e\u65b0\u3057\u3044 API\uff08&gt;=1.0\uff09\u306b\u5408\u308f\u305b\u3066\u5b9f\u88c5\u3055\u308c\u3066\u304a\u308a\u3001Step\u5b9f\u884c\u6642\u306b\u8ffd\u52a0\u306e\u5f15\u6570\u3092\u6e21\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u305b\u3093\u3002\u30b5\u30f3\u30d7\u30e9\u306e\u6319\u52d5\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u3053\u306e\u30ac\u30a4\u30c9\u306e\u5404\u30b9\u30c6\u30c3\u30d7\u3092\u53c2\u8003\u306b\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>"},{"location":"jax_control_flow_loops_ja/","title":"JAX Control Flow Loops (JA)","text":""},{"location":"jax_control_flow_loops_ja/#jax-scan-while_loop-fori_loop","title":"JAX \u306e\u5236\u5fa1\u30d5\u30ed\u30fc: scan / while_loop / fori_loop \u306e\u4f7f\u3044\u5206\u3051","text":"<p>\u3053\u306e\u30ce\u30fc\u30c8\u3067\u306f\u3001JAX \u306e\u4ee3\u8868\u7684\u306a\u30eb\u30fc\u30d7\u6f14\u7b97 <code>lax.scan</code> / <code>lax.while_loop</code> / <code>lax.fori_loop</code> \u306e\u9055\u3044\u3092\u3001\u7b49\u4fa1\u306a\u64ec\u4f3c Python \u30b3\u30fc\u30c9\u3068\u3068\u3082\u306b\u6574\u7406\u3057\u307e\u3059\u3002\u6700\u5f8c\u306b\u672c\u30ea\u30dd\u30b8\u30c8\u30ea\u306e <code>parameter_estimator_new.py</code> \u306b\u5b9f\u88c5\u3057\u305f Newton \u6cd5\uff08\u6700\u5927\u5316\uff09\u3067\u306e <code>while_loop</code> \u4f8b\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002</p>"},{"location":"jax_control_flow_loops_ja/#_1","title":"\u5171\u901a\u4e8b\u9805","text":"<ul> <li>\u3044\u305a\u308c\u3082\u300ccarry\uff08\u72b6\u614b\uff09\u3092\u53d7\u3051\u53d6\u308a\u3001\u6b21\u30b9\u30c6\u30c3\u30d7\u306e carry \u3092\u8fd4\u3059\u300d\u30b9\u30bf\u30a4\u30eb\u3002</li> <li>JIT / \u81ea\u52d5\u5fae\u5206\u306b\u5bfe\u5fdc\uff08\u30eb\u30fc\u30d7\u672c\u4f53\u306f JAX \u6f14\u7b97\u3092\u7528\u3044\u308b\uff09\u3002</li> <li>carry \u306e\u69cb\u9020\uff08PyTree\uff09\u304a\u3088\u3073\u5404\u8449\u306e shape/dtype \u306f\u5404\u30b9\u30c6\u30c3\u30d7\u3067\u4e0d\u5909\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002</li> </ul>"},{"location":"jax_control_flow_loops_ja/#laxscan","title":"lax.scan","text":"<ul> <li>\u56fa\u5b9a\u9577\u306e\u53cd\u5fa9\u3002\u7cfb\u5217\u5165\u529b <code>xs</code> \u3092\u8981\u7d20\u3054\u3068\u306b\u51e6\u7406\u3057\u3001\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u51fa\u529b\u3092\u81ea\u52d5\u3067\u30b9\u30bf\u30c3\u30af\u3057\u3066\u8fd4\u3057\u307e\u3059\u3002</li> <li>\u7f72\u540d\uff08\u6982\u5ff5\u56f3\uff09: <code>(carry, ys) = lax.scan(f, init, xs)</code></li> <li>\u8fd4\u308a\u5024: <code>final_carry, stacked_outputs</code></li> </ul>"},{"location":"jax_control_flow_loops_ja/#python","title":"\u7b49\u4fa1\u306a\u64ec\u4f3c Python \u30b3\u30fc\u30c9","text":"<pre><code>def scan(f, init, xs, length=None):\n    if xs is None:\n        xs = [None] * length\n    carry = init\n    ys = []\n    for x in xs:                # \u56fa\u5b9a\u9577\u3067\u6700\u5f8c\u307e\u3067\u56de\u308b\n        carry, y = f(carry, x)  # f: (carry, x) -&gt; (carry, y)\n        ys.append(y)\n    return carry, np.stack(ys)\n</code></pre>"},{"location":"jax_control_flow_loops_ja/#_2","title":"\u7279\u5fb4","text":"<ul> <li>\u65e9\u671f\u505c\u6b62\u306f\u3067\u304d\u307e\u305b\u3093\uff08\u5fc5\u8981\u306a\u3089 done \u30d5\u30e9\u30b0\u3067\u66f4\u65b0\u3092\u30de\u30b9\u30af\uff09\u3002</li> <li>\u9006\u4f1d\u64ad\u304c\u52b9\u7387\u7684\u306b\u5b9f\u88c5\u3055\u308c\u3066\u304a\u308a\u3001\u9577\u3044\u7cfb\u5217\u30bf\u30b9\u30af\u306b\u5411\u3044\u3066\u3044\u307e\u3059\u3002</li> <li>\u5c65\u6b74\uff08\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u51fa\u529b\uff09\u304c\u5fc5\u8981\u306a\u5834\u5408\u306b\u7b2c\u4e00\u5019\u88dc\u3002</li> </ul>"},{"location":"jax_control_flow_loops_ja/#laxwhile_loop","title":"lax.while_loop","text":"<ul> <li>\u53ce\u675f\u5224\u5b9a\u306a\u3069\u3001\u53cd\u5fa9\u56de\u6570\u304c\u5b9f\u884c\u6642\u306b\u6c7a\u307e\u308b\u30eb\u30fc\u30d7\u3002</li> <li>\u7f72\u540d\uff08\u6982\u5ff5\u56f3\uff09: <code>carry = lax.while_loop(cond, body, init_carry)</code></li> <li>\u8fd4\u308a\u5024: <code>final_carry</code>\uff08\u5c65\u6b74\u304c\u5fc5\u8981\u306a\u3089\u56fa\u5b9a\u9577\u30d0\u30c3\u30d5\u30a1\u3092 carry \u306b\u5165\u308c\u3066\u81ea\u524d\u3067\u4fdd\u6301\uff09\u3002</li> </ul>"},{"location":"jax_control_flow_loops_ja/#python_1","title":"\u7b49\u4fa1\u306a\u64ec\u4f3c Python \u30b3\u30fc\u30c9","text":"<pre><code>def while_loop(cond, body, init_carry):\n    carry = init_carry\n    while cond(carry):        # cond: carry -&gt; bool (JAX\u3067\u306f jnp.bool_)\n        carry = body(carry)   # body: carry -&gt; carry\n    return carry\n</code></pre>"},{"location":"jax_control_flow_loops_ja/#_3","title":"\u7279\u5fb4","text":"<ul> <li>\u65e9\u671f\u505c\u6b62\u304c\u53ef\u80fd\uff08\u53ce\u675f\u5224\u5b9a\u306a\u3069\uff09\u3002</li> <li><code>xs</code> \u306e\u3088\u3046\u306a\u7cfb\u5217\u5165\u529b\u5f15\u6570\u306f\u7121\u3044\u306e\u3067\u3001\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u5165\u529b\u3092\u5909\u3048\u305f\u3044\u5834\u5408\u306f carry \u5074\u306b\u5165\u308c\u3066\u81ea\u5206\u3067\u7ba1\u7406\u3057\u307e\u3059\uff08\u4f8b: <code>i</code> \u3068 <code>xs</code> \u3092\u6301\u3061\u3001<code>x_i = xs[i]</code> \u3092 body \u3067\u53d6\u308a\u51fa\u3059\uff09\u3002</li> <li>\u5c65\u6b74\u3092\u53d6\u308a\u305f\u3044\u5834\u5408\u306f\u3001\u56fa\u5b9a\u9577\u306e\u914d\u5217\u3092 carry \u306b\u5165\u308c\u3001<code>dynamic_update_slice</code> \u3084 <code>.at[i].set</code> \u3067\u57cb\u3081\u308b\u3002</li> </ul>"},{"location":"jax_control_flow_loops_ja/#laxfori_loop","title":"lax.fori_loop","text":"<ul> <li>\u56fa\u5b9a\u56de\u6570\u306e\u8efd\u91cf\u306a for \u30eb\u30fc\u30d7\uff08\u5c65\u6b74\u306f\u8fd4\u3055\u306a\u3044\uff09\u3002</li> <li>\u7f72\u540d\uff08\u6982\u5ff5\u56f3\uff09: <code>carry = lax.fori_loop(start, stop, body, init_carry)</code></li> <li>\u8fd4\u308a\u5024: <code>final_carry</code></li> </ul>"},{"location":"jax_control_flow_loops_ja/#python_2","title":"\u7b49\u4fa1\u306a\u64ec\u4f3c Python \u30b3\u30fc\u30c9","text":"<pre><code>def fori_loop(start, stop, body, init_carry):\n    carry = init_carry\n    for i in range(start, stop):  # \u56fa\u5b9a\u56de\u6570\n        carry = body(i, carry)     # body: (i, carry) -&gt; carry\n    return carry\n</code></pre>"},{"location":"jax_control_flow_loops_ja/#_4","title":"\u7279\u5fb4","text":"<ul> <li>\u5c65\u6b74\u304c\u4e0d\u8981\u304b\u3064\u56fa\u5b9a\u56de\u6570\u3067\u6e08\u3080\u51e6\u7406\u306b\u5411\u304d\u307e\u3059\u3002</li> <li>\u9006\u4f1d\u64ad\u306f\u53ef\u80fd\u3067\u3059\u304c\u3001\u5c65\u6b74\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f <code>scan</code> \u3092\u4f7f\u3046\u306e\u304c\u901a\u5e38\u3067\u3059\u3002</li> </ul>"},{"location":"jax_control_flow_loops_ja/#newton-while_loop","title":"\u672c\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u4f8b: Newton \u6cd5\uff08\u6700\u5927\u5316\uff09\u3067\u306e while_loop","text":"<p>\u30d5\u30a1\u30a4\u30eb: <code>src/degenerate_diffusion/estimation/parameter_estimator_new.py</code></p> <p>\u30cb\u30e5\u30fc\u30c8\u30f3\u4e0a\u6607\uff08\u6700\u5927\u5316\uff09\u306b\u304a\u3044\u3066\u3001\u52fe\u914d\u30ce\u30eb\u30e0 <code>||grad|| &lt;= tol</code> \u3067\u505c\u6b62\u3055\u305b\u308b\u305f\u3081 <code>jax.lax.while_loop</code> \u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002</p>"},{"location":"jax_control_flow_loops_ja/#_5","title":"\u8981\u7d04","text":"<ul> <li>carry = <code>(theta, it, converged)</code></li> <li><code>theta</code>: \u73fe\u5728\u306e\u63a8\u5b9a\u30d1\u30e9\u30e1\u30fc\u30bf\uff08JAX Array\uff09</li> <li><code>it</code>: \u53cd\u5fa9\u30ab\u30a6\u30f3\u30c8\uff08jnp.int32\uff09</li> <li><code>converged</code>: \u53ce\u675f\u30d5\u30e9\u30b0\uff08jnp.bool_\uff09</li> <li>cond: <code>it &lt; max_iters and not converged</code></li> <li>body: \u52fe\u914d\u30fb\u30d8\u30c3\u30bb\u3092\u8a08\u7b97\u3057\u3001\u6700\u5927\u5316\u7528\u306e\u5b89\u5b9a\u5316\u30d8\u30c3\u30bb <code>H_safe = H_sym - eps * I</code> \u3067\u30cb\u30e5\u30fc\u30c8\u30f3\u4e0a\u6607\u66f4\u65b0 \u2192 \u30dc\u30c3\u30af\u30b9\u5236\u7d04\u306b\u5c04\u5f71</li> </ul>"},{"location":"jax_control_flow_loops_ja/#_6","title":"\u64ec\u4f3c\u30b3\u30fc\u30c9\uff08\u672c\u5b9f\u88c5\u306e\u9aa8\u5b50\uff09","text":"<pre><code>import jax\nimport jax.numpy as jnp\n\nmax_iters = 10_000\nTol = 1e-7\nDamp = 0.1\nEps = 1e-8\nbounds = ...  # (d, 2)\n\ndef objective(theta, aux):\n    return ...  # \u30b9\u30ab\u30e9\u30fc\uff08\u6700\u5927\u5316\uff09\n\n@jax.jit\ndef newton_solve(theta0, aux):\n    theta0 = jnp.asarray(theta0)\n    b = bounds.astype(theta0.dtype)\n    false = jnp.zeros((), dtype=jnp.bool_)\n\n    def obj(th):\n        return jnp.asarray(objective(th, aux))\n\n    def grad(th):\n        return jax.grad(obj)(th)\n\n    def hess(th):\n        return jax.hessian(obj)(th)\n\n    def cond(carry):\n        th, it, conv = carry\n        return jnp.logical_and(it &lt; max_iters, jnp.logical_not(conv))\n\n    def body(carry):\n        th, it, _ = carry\n        g = grad(th)\n        H = hess(th)\n        H_sym = 0.5 * (H + H.T)\n        eye = jnp.eye(th.shape[0], dtype=th.dtype)\n        H_safe = H_sym - Eps * eye  # \u6700\u5927\u5316: \u8ca0\u5b9a\u65b9\u5411\u306b\u5b89\u5b9a\u5316\n        delta = jnp.linalg.solve(H_safe, g)\n        th_next = th - Damp * delta\n        th_next = jnp.clip(th_next, b[:, 0], b[:, 1])\n        conv = jnp.linalg.norm(g) &lt;= Tol\n        return th_next, it + 1, conv\n\n    th_fin, _, _ = jax.lax.while_loop(\n        cond,\n        body,\n        (theta0, jnp.asarray(0, jnp.int32), false),\n    )\n    return th_fin\n</code></pre>"},{"location":"jax_control_flow_loops_ja/#_7","title":"\u4f7f\u3044\u5206\u3051\u306e\u307e\u3068\u3081","text":"<ul> <li>\u53ce\u675f\u3084\u6761\u4ef6\u4ed8\u304d\u505c\u6b62\u304c\u5fc5\u8981 \u2192 <code>while_loop</code></li> <li>\u56fa\u5b9a\u9577\u30fb\u5c65\u6b74\uff08\u7cfb\u5217\u51fa\u529b\uff09\u304c\u5fc5\u8981 \u2192 <code>scan</code></li> <li>\u56fa\u5b9a\u9577\u30fb\u5c65\u6b74\u4e0d\u8981 \u2192 <code>fori_loop</code></li> </ul> <p>\u3044\u305a\u308c\u306e\u5834\u5408\u3082\u3001 - carry \u306e\u69cb\u9020\u30fb\u5404\u8449\u306e shape/dtype \u3092\u4e0d\u5909\u306b\u3059\u308b - \u5206\u5c90\u306f <code>lax.cond</code>\u3001\u7e70\u308a\u8fd4\u3057\u306f <code>scan/while_loop/fori_loop</code> - \u65e9\u671f\u505c\u6b62\u3092\u56fa\u5b9a\u9577\u3067\u30a8\u30df\u30e5\u30ec\u30fc\u30c8\u3057\u305f\u3044\u5834\u5408\u306f mask \u3092\u7528\u610f\u3059\u308b \u3068\u3044\u3063\u305f JAX \u306e\u304a\u4f5c\u6cd5\u3092\u5b88\u308b\u3068\u3001JIT/\u81ea\u52d5\u5fae\u5206\u3068\u76f8\u6027\u3088\u304f\u52d5\u4f5c\u3057\u307e\u3059\u3002</p>"},{"location":"likelihood_evaluator_guide/","title":"Likelihood Evaluator Guide","text":""},{"location":"likelihood_evaluator_guide/#likelihoodevaluator","title":"LikelihoodEvaluator \u5229\u7528\u30ac\u30a4\u30c9","text":"<p>\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001<code>degenerate_diffusion</code> \u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u542b\u307e\u308c\u308b <code>LikelihoodEvaluator</code> \u3068\u95a2\u9023\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u69cb\u9020\u3001\u5229\u7528\u624b\u9806\u3001\u6ce8\u610f\u70b9\u3092\u307e\u3068\u3081\u307e\u3059\u30022024 \u5e74\u30ea\u30d5\u30a1\u30af\u30bf\u5f8c\u306e\u65b0\u3057\u3044\u8a2d\u8a08\u306b\u57fa\u3065\u3044\u3066\u3044\u307e\u3059\u3002</p>"},{"location":"likelihood_evaluator_guide/#_1","title":"\u5168\u4f53\u69cb\u6210","text":"<p><code>LikelihoodEvaluator</code> \u306f\u4ee5\u4e0b 3 \u3064\u306e\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u3092\u675f\u306d\u308b\u30d5\u30a1\u30b5\u30fc\u30c9\u3067\u3059\u3002</p> <ul> <li><code>SymbolicLikelihoodPreparer</code></li> <li>SymPy \u3092\u4f7f\u3063\u3066\u884c\u5217 <code>C</code>, <code>V</code>, \u305d\u306e\u9006\u884c\u5217\u3084\u884c\u5217\u5f0f\u306a\u3069\u3092\u5c0e\u51fa\u3057\u3001JAX \u3067\u5b9f\u884c\u53ef\u80fd\u306a\u95a2\u6570\u3078 <code>lambdify</code> \u3057\u307e\u3059\u3002</li> <li>\u8a08\u7b97\u7d50\u679c\u306f <code>SymbolicPrecomputation</code> \u30c7\u30fc\u30bf\u30af\u30e9\u30b9\uff08\u5f8c\u8ff0\uff09\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002</li> <li><code>InfinitesimalGenerator</code></li> <li>\u7121\u9650\u5c0f\u751f\u6210\u4f5c\u7528\u7d20 \\(L\\) \u3068\u305d\u306e\u6b63\u898f\u5316 \\(L_0\\) \u3092\u6271\u3044\u307e\u3059\u3002</li> <li>SymPy \u306e\u5f0f\u3092\u518d\u5229\u7528\u3059\u308b\u305f\u3081\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6301\u3061\u3001<code>L</code>, <code>L_0</code>, <code>L_0_func</code> \u3092\u5916\u90e8\u306b\u63d0\u4f9b\u3057\u307e\u3059\u3002</li> <li><code>QuasiLikelihoodEvaluator</code></li> <li>JAX \u4e0a\u3067\u7591\u4f3c\u5c24\u5ea6\u3092\u8a08\u7b97\u3059\u308b\u5404\u7a2e\u30d5\u30a1\u30af\u30c8\u30ea (<code>make_quasi_likelihood_l*_evaluator</code>) \u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002</li> <li>\u5404\u30d5\u30a1\u30af\u30c8\u30ea\u306e\u623b\u308a\u5024\u306f JAX \u306e <code>jit</code> \u6e08\u307f\u95a2\u6570\u306a\u306e\u3067\u3001\u751f\u6210\u5f8c\u3059\u3050\u9ad8\u901f\u306b\u8a55\u4fa1\uff0f\u81ea\u52d5\u5fae\u5206\u3078\u6e21\u305b\u307e\u3059\u3002</li> <li><code>S(k)</code> \u3092\u547c\u3073\u51fa\u3059\u3068\u3001\u5404\u30c6\u30f3\u30bd\u30eb\u6210\u5206\u306e\u8a18\u53f7\u5f0f\u3068\u5bfe\u5fdc\u3059\u308b JAX \u95a2\u6570\u3092\u307e\u3068\u3081\u305f <code>SymbolicArtifact</code> \u306e\u30bf\u30d7\u30eb\u304c\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002</li> <li><code>SymbolicPrecomputation</code> \u3092\u53c2\u7167\u3057\u3001\u5229\u7528\u53ef\u80fd\u306a\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u3092\u691c\u67fb\u3057\u305f\u4e0a\u3067 evaluators \u3092\u751f\u6210\u3057\u307e\u3059\u3002</li> </ul>"},{"location":"likelihood_evaluator_guide/#_2","title":"\u88dc\u52a9\u30af\u30e9\u30b9","text":"<ul> <li><code>SymbolicArtifact</code></li> <li>\u8a18\u53f7\u5f0f (<code>expr</code>) \u3068\u5bfe\u5fdc\u3059\u308b JAX \u95a2\u6570 (<code>func</code>) \u3092\u307e\u3068\u3081\u305f\u30c7\u30fc\u30bf\u30b3\u30f3\u30c6\u30ca\u3002</li> <li><code>QuasiLikelihoodEvaluator.S(k)</code> \u306a\u3069\u304c\u8fd4\u3059\u6210\u679c\u7269\u306b\u3082\u3053\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u308f\u308c\u307e\u3059\u3002</li> <li><code>SymbolicPrecomputation</code></li> <li>\u524d\u51e6\u7406\u6e08\u307f\u306e\u8a18\u53f7\u5f0f\u3068\u95a2\u6570\u3092\u307e\u3068\u3081\u305f\u4e0d\u5909\u30c7\u30fc\u30bf\u30af\u30e9\u30b9\u3002</li> <li>\u4f8b\u5916\u30af\u30e9\u30b9</li> <li><code>SymbolicPreparationError</code>: \u8a18\u53f7\u524d\u51e6\u7406\u3067\u81f4\u547d\u7684\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u306b\u9001\u51fa\u3002</li> </ul>"},{"location":"likelihood_evaluator_guide/#_3","title":"\u4f7f\u3044\u65b9\u306e\u6d41\u308c","text":"<ol> <li>\u30e2\u30c7\u30eb\u306e\u6e96\u5099</li> <li><code>DegenerateDiffusionProcess</code> \u306a\u3069\u3001<code>A_func</code>, <code>B_func</code>, <code>H_func</code> \u3092 JAX \u4e92\u63db\u3067\u63d0\u4f9b\u3059\u308b\u30e2\u30c7\u30eb\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7528\u610f\u3057\u307e\u3059\u3002</li> <li> <p><code>LikelihoodEvaluator</code> \u306e\u521d\u671f\u5316\u6642\u306b\u3053\u308c\u3089\u306e\u95a2\u6570\u304c\u5b58\u5728\u3057\u306a\u3044\u3068 <code>AttributeError</code> \u3068\u306a\u308a\u307e\u3059\u3002</p> </li> <li> <p><code>LikelihoodEvaluator</code> \u3092\u521d\u671f\u5316 </p><pre><code>likelihood = LikelihoodEvaluator(model)\n</code></pre><p></p> </li> <li> <p>\u65e2\u306b\u524d\u51e6\u7406\u7d50\u679c\u304c\u3042\u308b\u5834\u5408\u306f <code>precomputed=SymbolicPrecomputation(...)</code> \u3092\u6e21\u3057\u3066\u518d\u5229\u7528\u53ef\u80fd\u3067\u3059\u3002</p> </li> <li> <p>\u521d\u671f\u5316\u30a8\u30e9\u30fc\u306e\u78ba\u8a8d </p><pre><code>from degenerate_diffusion.evaluation.likelihood_evaluator import SymbolicPreparationError\n\ntry:\n    likelihood = LikelihoodEvaluator(model)\nexcept SymbolicPreparationError as exc:\n    raise RuntimeError(\"\u524d\u51e6\u7406\u306b\u5931\u6557\u3057\u307e\u3057\u305f\") from exc\n</code></pre><p></p> </li> <li> <p>C \u3084 V \u304c\u7279\u7570\u306a\u5834\u5408\u306a\u3069\u306f\u521d\u671f\u5316\u6642\u306b <code>SymbolicPreparationError</code> \u304c\u9001\u51fa\u3055\u308c\u308b\u305f\u3081\u3001\u30e2\u30c7\u30eb\u5f0f\u3084\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8abf\u6574\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p> </li> <li> <p>\u7591\u4f3c\u5c24\u5ea6\u306e evaluator \u3092\u751f\u6210</p> </li> <li><code>make_quasi_likelihood_l1_evaluator</code>, <code>make_quasi_likelihood_l1_prime_evaluator</code>, <code>make_quasi_likelihood_l2_evaluator</code>, <code>make_quasi_likelihood_l3_evaluator</code> \u3092\u7528\u9014\u306b\u5fdc\u3058\u3066\u547c\u3073\u51fa\u3057\u307e\u3059\u3002\u623b\u308a\u5024\u306f\u3059\u3079\u3066 <code>jit</code> \u6e08\u307f\u306e callable \u3067\u3059\u3002</li> <li> <p>\u5fc5\u9808\u6210\u5206\u304c\u6b20\u3051\u3066\u3044\u308b\u5834\u5408\u306f\u521d\u671f\u5316\u6642\u70b9\u3067 <code>SymbolicPreparationError</code> \u304c\u9001\u51fa\u3055\u308c\u308b\u305f\u3081\u3001\u30e2\u30c7\u30eb\u5f0f\u3084\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8abf\u6574\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p> </li> <li> <p>\u6700\u9069\u5316\u30eb\u30fc\u30c1\u30f3\u3078\u6e21\u3059</p> </li> <li>evaluator \u306f callable (JAX \u95a2\u6570) \u3092\u8fd4\u3057\u307e\u3059\u3002<code>parameter_estimator.m_estimate</code> \u3084 <code>newton_solve</code> \u306a\u3069\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u30d1\u30e9\u30e1\u30fc\u30bf\u63a8\u5b9a\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002</li> </ol>"},{"location":"likelihood_evaluator_guide/#sympy","title":"SymPy \u306b\u3088\u308b\u8a18\u53f7\u5f0f\u306e\u7c21\u7d04\u3068\u9ad8\u901f\u5316","text":"<p>V1 \u7cfb\u306e\u7591\u4f3c\u5c24\u5ea6\u306f\u9ad8\u6b21\u306e <code>S_l</code> \u30c6\u30f3\u30bd\u30eb\u3092\u591a\u6570\u8a55\u4fa1\u3059\u308b\u305f\u3081\u3001lambdify \u3055\u308c\u305f\u95a2\u6570\u304c\u5927\u304d\u304f\u306a\u308a\u304c\u3061\u3067\u3059\u30022024.06 \u6642\u70b9\u306e\u5b9f\u88c5\u3067\u306f\u3001<code>degenerate_diffusion/evaluation/likelihood_evaluator.py:424-440</code> \u3067 SymPy \u306e\u7c21\u7d04\u6a5f\u80fd\u3092\u4f7f\u3044\u3001JAX \u5074\u306e\u5b9f\u884c\u30b3\u30b9\u30c8\u3092\u6291\u3048\u3066\u3044\u307e\u3059\u3002\u4ed5\u7d44\u307f\u306f\u6b21\u306e\u901a\u308a\u3067\u3059\u3002</p> <ul> <li><code>sympy.simplify</code> \u306e\u9069\u7528</li> <li><code>Array(...).applyfunc(sp.simplify)</code> \u3068\u3059\u308b\u3053\u3068\u3067\u3001\u30c6\u30f3\u30bd\u30eb\u306e\u5404\u8981\u7d20\u3054\u3068\u306b\u7c21\u7d04\u3092\u8a66\u307f\u307e\u3059\u3002</li> <li><code>_simplify_tensor</code> \u30d8\u30eb\u30d1\u30fc\u3092\u4ecb\u3057\u3066 <code>S_xx</code>, <code>S_xy</code>, <code>S_yx</code>, <code>S_yy</code> \u305d\u308c\u305e\u308c\u306b\u540c\u3058\u51e6\u7406\u3092\u5b9f\u65bd\u3057\u3066\u3044\u307e\u3059\u3002</li> <li> <p><code>simplify</code> \u306f\u5f0f\u3092\u7e2e\u7d04\u3059\u308b\u3053\u3068\u304c\u591a\u3044\u4e00\u65b9\u3001\u5834\u5408\u306b\u3088\u3063\u3066\u306f\u8907\u96d1\u5316\u3055\u305b\u308b\u3053\u3068\u3082\u3042\u308a\u307e\u3059\u3002\u5b9f\u88c5\u3067\u306f\u30c6\u30f3\u30bd\u30eb\u8981\u7d20\u3054\u3068\u306b\u9069\u7528\u3057\u3001\u5f8c\u7d9a\u306e <code>lambdify</code> \u3067\u751f\u6210\u3055\u308c\u308b JAX \u95a2\u6570\u306e\u30b5\u30a4\u30ba\u3092\u6291\u5236\u3057\u3066\u3044\u307e\u3059\u3002</p> </li> <li> <p><code>sympy.cse</code>\uff08\u5171\u901a\u90e8\u5206\u5f0f\u62bd\u51fa\uff09\u306e\u5229\u7528</p> </li> <li><code>lambdify(..., modules=\"jax\", cse=True)</code> \u3092\u6307\u5b9a\u3059\u308b\u3068\u3001SymPy \u304c\u5f0f\u5185\u306e\u5171\u901a\u90e8\u5206\u3092\u81ea\u52d5\u62bd\u51fa\u3057\u3001JAX \u306e\u6f14\u7b97\u3068\u3057\u3066\u3082\u4e00\u5ea6\u3060\u3051\u8a55\u4fa1\u3059\u308b\u3088\u3046\u306b\u5909\u63db\u3057\u3066\u304f\u308c\u307e\u3059\u3002</li> <li> <p><code>simplify</code> \u3068\u7d44\u307f\u5408\u308f\u305b\u308b\u3053\u3068\u3067\u3001<code>k</code> \u304c\u5927\u304d\u3044\u5834\u5408\u3067\u3082 JIT \u5f8c\u306e\u5b9f\u884c\u304c\u5927\u5e45\u306b\u9ad8\u901f\u5316\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059\u3002</p> </li> <li> <p>\u5c0e\u5165\u624b\u9806\u306e\u30dd\u30a4\u30f3\u30c8</p> </li> <li>SymPy \u3067\u5f97\u305f\u30c6\u30f3\u30bd\u30eb\uff08<code>Array</code>\uff09\u3092 <code>simplify</code> \u3059\u308b\u3002</li> <li><code>lambdify</code> \u3059\u308b\u969b\u306b <code>cse=True</code> \u3092\u4ed8\u3051\u308b\u3002</li> <li>\u751f\u6210\u3055\u308c\u305f <code>SymbolicArtifact</code> \u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u3001JAX evaluator \u304b\u3089\u518d\u5229\u7528\u3059\u308b\u3002</li> </ul> <p>\u3053\u308c\u3089\u306e\u51e6\u7406\u306f\u65e2\u5b58\u30b3\u30fc\u30c9\u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u30e6\u30fc\u30b6\u30fc\u5074\u3067\u8ffd\u52a0\u4f5c\u696d\u306f\u4e0d\u8981\u3067\u3059\u3002\u72ec\u81ea\u306b\u30c6\u30f3\u30bd\u30eb\u5f0f\u3092\u62e1\u5f35\u3059\u308b\u5834\u5408\u306f\u3001\u540c\u3058\u30d1\u30bf\u30fc\u30f3\u3092\u8e0f\u8972\u3059\u308b\u3068\u8a55\u4fa1\u30b3\u30b9\u30c8\u3092\u6291\u3048\u3084\u3059\u304f\u306a\u308a\u307e\u3059\u3002</p>"},{"location":"likelihood_evaluator_guide/#evaluator","title":"\u5404 evaluator \u306e\u4f9d\u5b58\u95a2\u4fc2","text":"evaluator \u76ee\u7684 \u8981\u6c42\u3055\u308c\u308b\u4e3b\u306a\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8 <code>l1</code> (<code>make_quasi_likelihood_l1_evaluator</code>) \u30d5\u30eb\u7591\u4f3c\u5c24\u5ea6 <code>inv_S0_*</code> \u7cfb\u3001<code>log_det_S0</code> <code>l1_prime</code> (<code>make_quasi_likelihood_l1_prime_evaluator</code>) \u4e00\u90e8\u7c21\u7565\u5316\u7248 <code>inv_C</code>, <code>log_det_C</code> <code>l2</code> (<code>make_quasi_likelihood_l2_evaluator</code>) \\(\\theta_2\\) \u5411\u3051 <code>inv_C</code> <code>l3</code> (<code>make_quasi_likelihood_l3_evaluator</code>) \\(\\theta_3\\) \u5411\u3051 <code>inv_V</code>, <code>partial_x_H^T V^{-1}</code> <p><code>l3</code> \u306f\u7279\u306b <code>V</code> \u304c\u7279\u7570\u306a\u5834\u5408\u306b\u521d\u671f\u5316\u6bb5\u968e\u3067\u5931\u6557\u3059\u308b\u305f\u3081\u3001<code>LikelihoodEvaluator</code> \u306e\u751f\u6210\u6642\u306b <code>SymbolicPreparationError</code> \u3092\u6355\u6349\u3057\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u30e2\u30c7\u30eb\u306e\u8a18\u53f7\u5f0f\u3092\u4fee\u6b63\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>"},{"location":"likelihood_evaluator_guide/#l-l_0","title":"<code>L</code> / <code>L_0</code> \u306e\u5229\u7528","text":"<ul> <li>\u8a18\u53f7\u5f0f\u306e\u5165\u529b\u306b\u5bfe\u3057\u3066 \\(L^k f\\) \u3084 \\(L_0^k f\\) \u3092\u8a08\u7b97\u3067\u304d\u307e\u3059\u3002</li> <li><code>L_0_func</code> \u306f (x, y, \u03b8\u2081, \u03b8\u2082, \u03b8\u2083) \u3092\u5f15\u6570\u306b\u53d6\u308b JAX \u4e92\u63db\u306e\u95a2\u6570\u3092\u8fd4\u3059\u305f\u3081\u3001\u7591\u4f3c\u5c24\u5ea6\u8a08\u7b97\u5185\u90e8\u3067\u3082\u5229\u7528\u3055\u308c\u3066\u3044\u307e\u3059\u3002</li> <li>\u5185\u90e8\u30ad\u30e3\u30c3\u30b7\u30e5\u306f SymPy \u306e\u5f0f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u4e0d\u5909\u5316\u3057\u3066\u30ad\u30fc\u306b\u3059\u308b\u65b9\u5f0f\u3078\u5909\u66f4\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u65e7\u6765\u306e <code>srepr</code> \u30d9\u30fc\u30b9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3088\u308a\u9811\u5065\u3067\u3059\u3002</li> </ul>"},{"location":"likelihood_evaluator_guide/#fnmodelipynb","title":"\u4f8b: <code>FNmodel.ipynb</code> \u306e\u629c\u7c8b","text":"<pre><code>likelihood = LikelihoodEvaluator(FNmodel)\n\nlk1 = likelihood.make_quasi_likelihood_l1_evaluator(\n    x_series=x_series, y_series=y_series, h=h, k=3\n)\n\nlk3 = likelihood.make_quasi_likelihood_l3_evaluator(\n    x_series=x_series, y_series=y_series, h=h, k=3\n)\n</code></pre>"},{"location":"likelihood_evaluator_guide/#_4","title":"\u767a\u751f\u3057\u3046\u308b\u4f8b\u5916","text":"<ul> <li><code>SymbolicPreparationError</code></li> <li>\u8a18\u53f7\u8a08\u7b97\u306e\u904e\u7a0b\u3067\u9006\u884c\u5217\u304c\u8a08\u7b97\u3067\u304d\u306a\u3044\u306a\u3069\u81f4\u547d\u7684\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u306b\u9001\u51fa\u3002</li> <li>\u30e2\u30c7\u30eb\u306e\u5b9a\u7fa9\uff08<code>B</code>, <code>H</code> \u306a\u3069\uff09\u3092\u518d\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> <li><code>ValueError</code></li> <li><code>make_quasi_*</code> \u304c\u6642\u7cfb\u5217\u9577\u30c1\u30a7\u30c3\u30af\u3084 <code>k</code> \u306e\u975e\u8ca0\u30c1\u30a7\u30c3\u30af\u3067\u5229\u7528\u3002</li> <li><code>IndexError</code></li> <li><code>Dx_func</code>/<code>Dy_func</code> \u3067\u8981\u6c42\u3055\u308c\u308b L\u2080 \u306e\u6b21\u6570\u304c\u672a\u751f\u6210\u306e\u5834\u5408\u306b\u660e\u793a\u7684\u306b\u767a\u751f\u3055\u305b\u307e\u3059\u3002<code>k</code> \u3068 L\u2080 \u306e\u751f\u6210\u7bc4\u56f2\u304c\u4e00\u81f4\u3059\u308b\u3088\u3046\u306b\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> </ul>"},{"location":"likelihood_evaluator_guide/#_5","title":"\u65e7\u30d0\u30fc\u30b8\u30e7\u30f3\u3068\u306e\u9055\u3044","text":"<ul> <li>\u521d\u671f\u5316\u6642\u306b\u8a18\u53f7\u8a08\u7b97\u304c\u5931\u6557\u3057\u305f\u5834\u5408\u306f <code>SymbolicPreparationError</code> \u3092\u9001\u51fa\u3059\u308b\u8a2d\u8a08\u306b\u7d71\u4e00\u3057\u307e\u3057\u305f\u3002</li> <li>\u5927\u91cf\u306e\u30ed\u30b8\u30c3\u30af\u304c 1 \u30af\u30e9\u30b9\u306b\u96c6\u7d04\u3055\u308c\u3066\u3044\u305f\u69cb\u9020\u304b\u3089\u3001\u5f79\u5272\u3054\u3068\u306e\u5c02\u7528\u30af\u30e9\u30b9\u3078\u5206\u5272\u3055\u308c\u3066\u3044\u307e\u3059\u3002</li> <li>\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u304c <code>srepr</code> \u6587\u5b57\u5217\u304b\u3089\u3001SymPy \u5f0f\u306e\u4e0d\u5909\u5316\u30c7\u30fc\u30bf\u3078\u5909\u66f4\u3055\u308c\u307e\u3057\u305f\u3002</li> <li>\u521d\u671f\u5316\u3067\u8a18\u53f7\u8a08\u7b97\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u4f8b\u5916\u3067\u5373\u5ea7\u306b\u4f1d\u64ad\u3059\u308b\u3088\u3046\u7d71\u4e00\u3057\u3001\u6b20\u640d\u3057\u305f\u6210\u679c\u7269\u3092\u6b8b\u3055\u306a\u3044\u8a2d\u8a08\u306b\u3057\u307e\u3057\u305f\u3002</li> <li><code>DegenerateDiffusionProcess</code> \u5074\u3067\u3082 <code>A</code>/<code>B</code>/<code>H</code> \u3092 <code>SymbolicArtifact</code> \u3068\u3057\u3066\u4fdd\u6301\u3057\u3001\u7591\u4f3c\u5c24\u5ea6\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u5168\u4f53\u3067\u540c\u3058\u53d6\u308a\u6271\u3044\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002</li> </ul>"},{"location":"likelihood_evaluator_guide/#_6","title":"\u8a2d\u8a08\u30e1\u30e2","text":"<ul> <li>SymPy \u306e <code>derive_by_array</code> \u306f\u901a\u5e38\u306e\u5fae\u5206\u4fc2\u6570\u304c\u305d\u306e\u307e\u307e\u5f0f\u306e\u524d\u306b\u639b\u304b\u308b\u5f62\u3067\u8fd4\u3063\u3066\u304f\u308b\u305f\u3081\u3001\u4fc2\u6570\u304c\u5897\u3048\u308b\u7b87\u6240\u3092\u60f3\u5b9a\u3057\u305f\u3046\u3048\u3067\u5f8c\u6bb5\u306e\u51e6\u7406\u3092\u7d44\u3080\u3002</li> <li> <p><code>SymbolicPreparationError</code> \u3092\u6355\u6349\u3059\u308b\u3053\u3068\u3067\u3001\u8a18\u53f7\u8a08\u7b97\u306e\u5931\u6557\u539f\u56e0\u3092\u65e9\u671f\u306b\u77e5\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002</p> </li> <li> <p>\u7d44\u307f\u8fbc\u307f\u306e\u884c\u5217 <code>C_sym</code> \u3084 <code>C_func</code> \u306f\u5fc5\u305a\u69cb\u7bc9\u3055\u308c\u308b\u524d\u63d0\u306a\u306e\u3067\u3001\u30e9\u30c3\u30d1\u30fc\u30af\u30e9\u30b9\u3092\u8a2d\u3051\u305a\u7d20\u306e\u307e\u307e\u4fdd\u6301\u3057\u3066\u3044\u307e\u3059\u3002</p> </li> <li>\u4e00\u65b9\u3067\u9006\u884c\u5217\u3084 log det \u306a\u3069\u306f\u7279\u7570\u3067\u8a08\u7b97\u3067\u304d\u306a\u3044\u30b1\u30fc\u30b9\u304c\u3042\u308b\u305f\u3081 <code>SymbolicArtifact</code> \u3067\u5024\u3068\u72b6\u614b\u3092\u4e00\u7dd2\u306b\u6301\u305f\u305b\u3001\u6b20\u640d\u304c\u5224\u660e\u3057\u305f\u6642\u70b9\u3067\u4f8b\u5916\u3092\u9001\u51fa\u3057\u3066\u539f\u56e0\u3092\u660e\u793a\u3057\u3066\u3044\u307e\u3059\u3002</li> <li><code>SymbolicPrecomputation</code> \u3092 <code>frozen=True</code> \u306b\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u751f\u6210\u5f8c\u306b\u5185\u90e8\u72b6\u614b\u3092\u5dee\u3057\u66ff\u3048\u305a\uff08\u518d lambdify \u305b\u305a\uff09\u5b89\u5168\u306b\u53c2\u7167\u5171\u7528\u3059\u308b\u305f\u3081\u3067\u3059\u3002\u66f4\u65b0\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u5834\u5408\u306f\u518d\u751f\u6210\u3057\u307e\u3059\u3002</li> </ul>"},{"location":"likelihood_evaluator_guide/#_7","title":"\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0","text":"<ul> <li><code>SymbolicPreparationError</code> \u304c\u6295\u3052\u3089\u308c\u308b</li> <li><code>C</code> \u3084 <code>V</code> \u306e\u8a18\u53f7\u8a08\u7b97\u304c\u5931\u6557\u3057\u305f\u5834\u5408\u3001\u521d\u671f\u5316\u6642\u306b <code>SymbolicPreparationError</code> \u304c\u751f\u3058\u307e\u3059\u3002\u30e2\u30c7\u30eb\u5074\u306e\u5f0f\u3084\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8abf\u6574\u3057\u3001\u518d\u5ea6\u521d\u671f\u5316\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> <li>\u7591\u4f3c\u5c24\u5ea6\u304c <code>nan</code> \u3092\u8fd4\u3059</li> <li>JAX \u306e\u8a08\u7b97\u4e2d\u3067\u975e\u6709\u754c\u5024\u304c\u51fa\u305f\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u5165\u529b\u30c7\u30fc\u30bf\u306e\u30b9\u30b1\u30fc\u30eb\u3084 <code>theta</code> \u306e\u521d\u671f\u5024\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> <li><code>IndexError</code> \u304c <code>Dx_func</code> \u304b\u3089\u51fa\u308b</li> <li><code>make_quasi_*</code> \u306b\u6e21\u3057\u305f <code>k</code> \u3068 L\u2080 \u95a2\u6570\u306e\u78ba\u4fdd\u6570\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u6a19\u6e96\u63d0\u4f9b\u306e\u30d5\u30a1\u30af\u30c8\u30ea\u3067\u306f <code>k</code> \u306e\u5024\u306b\u5408\u308f\u305b\u3066\u5341\u5206\u306a L\u2080 \u3092\u751f\u6210\u3057\u307e\u3059\u3002</li> </ul>"},{"location":"likelihood_evaluator_guide/#_8","title":"\u53c2\u8003\u60c5\u5831","text":"<ul> <li>\u63a8\u5b9a\u30eb\u30fc\u30c1\u30f3: <code>degenerate_diffusion/estimation/parameter_estimator.py</code></li> <li>\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u4f8b: <code>degenerate_diffusion/processes/degenerate_diffusion_process.py</code></li> <li>Notebook \u30b5\u30f3\u30d7\u30eb: <code>FNmodel.ipynb</code></li> </ul> <p>\u4ee5\u4e0a\u3092\u53c2\u8003\u306b\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066 Notebook \u3084\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u7d44\u307f\u8fbc\u3093\u3067\u304f\u3060\u3055\u3044\u3002</p>"},{"location":"optax_basics_ja/","title":"Optax Basics (JA)","text":""},{"location":"optax_basics_ja/#optax","title":"Optax \u306e\u6700\u5c0f\u30eb\u30fc\u30eb\u3068\u672c\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u306e\u4f7f\u3044\u65b9","text":"<p>\u3053\u306e\u30ce\u30fc\u30c8\u306f Optax \u306e\u300c\u6700\u5c0f\u9650\u306e\u6587\u6cd5\u3068\u8a2d\u8a08\u30eb\u30fc\u30eb\u300d\u3092\u3001\u624b\u524d\u5473\u564c\u306b\u306a\u3089\u306a\u3044\u30ec\u30d9\u30eb\u3067\u77ed\u304f\u6574\u7406\u3057\u307e\u3059\u3002\u6700\u521d\u306b\u300cOptax \u306f\u9ed2\u7bb1\u3067\u306f\u306a\u304f\u7d44\u307f\u7acb\u3066\u5f0f\u300d\u300cstate \u3068 updates \u304c\u809d\u300d\u3068\u3044\u3046\u8981\u70b9\u3092\u5148\u306b\u62bc\u3055\u3048\u3001\u305d\u306e\u3046\u3048\u3067\u4f7f\u3044\u65b9\u3068\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3\u3092\u793a\u3057\u307e\u3059\u3002</p>"},{"location":"optax_basics_ja/#0-update-1","title":"0. \u307e\u305a\u62bc\u3055\u3048\u308b\u7d50\u8ad6\uff08\u9ed2\u7bb1\u3067\u306f\u306a\u3044\uff0fupdate \u306f1\u30b9\u30c6\u30c3\u30d7\uff09","text":"<ul> <li>Optax \u306f SciPy \u306e minimize \u306e\u3088\u3046\u306a\u201c\u624b\u6cd5\u3092\u9078\u3076\u3060\u3051\u306e\u9ed2\u7bb1\u201d\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u524d\u51e6\u7406\u3084\u66f4\u65b0\u5247\u306a\u3069\u306e\u300c\u5909\u63db\uff08transform\uff09\u300d\u3092\u7d44\u307f\u5408\u308f\u305b\u3001\u3042\u306a\u305f\u304c\u6700\u9069\u5316\u30eb\u30fc\u30d7\u3092\u7d44\u307f\u7acb\u3066\u307e\u3059\u3002</li> <li><code>optimizer.update(grads, state, params)</code> \u306f\u300c\u305d\u306e1\u56de\u5206\u306e\u66f4\u65b0\u91cf\uff08updates\uff09\u300d\u3068\u300c\u6b21\u306e\u5185\u90e8\u72b6\u614b\uff08state\uff09\u300d\u3092\u8fd4\u3059\u3060\u3051\u3067\u3059\u3002\u8907\u6570\u56de\u306e\u66f4\u65b0\u3092\u307e\u3068\u3081\u3066\u884c\u3046\u3082\u306e\u3067\u306f\u3042\u308a\u307e\u305b\u3093\uff08\u8907\u6570\u56de\u306f fori_loop/scan/while_loop \u3067\u56de\u3057\u307e\u3059\uff09\u3002</li> </ul>"},{"location":"optax_basics_ja/#1","title":"1. \u7528\u8a9e\uff08\u6700\u521d\u306b\u3053\u3053\u3060\u3051\uff09","text":"<ul> <li>Transform\uff08\u5909\u63db\uff09: <code>optax.adamw(...)</code> \u3084 <code>optax.clip_by_global_norm(...)</code> \u304c\u8fd4\u3059\u300c\u6700\u9069\u5316\u51e6\u7406\u306e\u90e8\u54c1\u300d\u3002<code>init / update</code> \u3092\u6301\u3064\u3002</li> <li>Optimizer State\uff08\u6700\u9069\u5316\u5668\u306e\u72b6\u614b\uff09: \u30e2\u30e1\u30f3\u30bf\u30e0\u3084\u4e8c\u4e57\u5e73\u5747\u306a\u3069\u3001\u5909\u63db\u304c\u5185\u90e8\u3067\u4fdd\u6301\u3059\u308b\u7d71\u8a08\u306e PyTree\u3002<code>state = optimizer.init(params)</code> \u3067\u4f5c\u308b\u3002</li> <li>Updates\uff08\u66f4\u65b0\u91cf\uff09: <code>optimizer.update(...)</code> \u304c\u8fd4\u3059\u3001\u30d1\u30e9\u30e1\u30bf\u3068\u540c\u5f62\u306e\u5dee\u5206 PyTree\u3002<code>optax.apply_updates(params, updates)</code> \u3067\u9069\u7528\uff08\u672c\u8cea\u7684\u306b params + updates\uff09\u3002</li> <li>Params\uff08\u30d1\u30e9\u30e1\u30bf\uff09: \u5b66\u7fd2\u5bfe\u8c61\uff08PyTree\uff09\u3002<code>init / update</code> \u306e\u5f62\u72b6\u306e\u57fa\u6e96\u3002</li> <li>Chain\uff08\u9023\u7d50\uff09: <code>optax.chain(t1, t2, ...)</code> \u3067\u5909\u63db\u3092\u5de6\u304b\u3089\u9806\u306b\u9069\u7528\uff08\u4f8b: \u30af\u30ea\u30c3\u30d7 \u2192 AdamW\uff09\u3002</li> </ul>"},{"location":"optax_basics_ja/#2-init-update-apply","title":"2. \u57fa\u672c\u30e2\u30c7\u30eb\uff08init / update / apply\uff09","text":"<ul> <li>\u5909\u63db\uff08Transform\uff09\u306f\u6b21\u306e3\u5f79\u5272\u3092\u6301\u3061\u307e\u3059\u3002   1) <code>init(params)</code> \u2192 Optimizer State \u3092\u4f5c\u308b   2) <code>update(grads, state, params)</code> \u2192 (updates, next_state) \u3092\u8fd4\u3059   3) <code>optax.apply_updates(params, updates)</code> \u2192 \u65b0\u3057\u3044 params \u3092\u5f97\u308b\uff08\u8981\u7d20\u3054\u3068\u306e\u52a0\u7b97\uff09</li> </ul> <p>\u3053\u308c\u304c Optax \u306e\u6839\u5e79\u3067\u3059\u3002</p>"},{"location":"optax_basics_ja/#3-optimizer-state-adamw","title":"3. Optimizer State \u3092\u8a73\u3057\u304f\uff08AdamW \u3092\u4f8b\u306b\uff09","text":"<p>Optimizer State \u306f\u3001\u5404 transform \u304c\u300c\u66f4\u65b0\u3092\u9069\u5fdc\u7684\u306b\u6c7a\u3081\u308b\u305f\u3081\u306b\u5fc5\u8981\u306a\u5185\u90e8\u7d71\u8a08\u300d\u3092\u4fdd\u6301\u3059\u308b PyTree \u3067\u3059\u3002Adam/AdamW \u306e\u5178\u578b\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002</p> <ul> <li>m\uff08\u4e00\u6b21\u30e2\u30fc\u30e1\u30f3\u30c8\uff09: \u52fe\u914d\u306e\u79fb\u52d5\u5e73\u5747\uff08\u30e2\u30e1\u30f3\u30bf\u30e0\uff09</li> <li>v\uff08\u4e8c\u6b21\u30e2\u30fc\u30e1\u30f3\u30c8\uff09: \u52fe\u914d\u4e8c\u4e57\u306e\u79fb\u52d5\u5e73\u5747</li> <li>count: \u53cd\u5fa9\u30ab\u30a6\u30f3\u30c8\uff08\u30d0\u30a4\u30a2\u30b9\u88dc\u6b63\u306b\u4f7f\u3046\uff09</li> </ul> <p>\u6700\u5c0f\u5316\u898f\u7d04\u3067\u306e\u66f4\u65b0\u306e\u6982\u5ff5\u5f0f: </p><pre><code>m_t = \u03b21 * m_{t-1} + (1-\u03b21) * g_t\nv_t = \u03b22 * v_{t-1} + (1-\u03b22) * (g_t \u2299 g_t)\nm\u0302_t = m_t / (1 - \u03b21^t)\nv\u0302_t = v_t / (1 - \u03b22^t)\nupdates = - lr * m\u0302_t / (sqrt(v\u0302_t) + \u03b5)\n# AdamW \u306f decoupled weight decay \u306b\u3088\u308a\u3001\u52fe\u914d\u3068\u306f\u72ec\u7acb\u306b params \u3092\u6e1b\u8870\nparams_next = params + updates  -  lr * weight_decay * params\n</code></pre> \u5b9f\u969b\u306b\u306f\u3001\u3053\u308c\u3089\u306f <code>optimizer.update(grads, state, params)</code> \u306e\u5185\u90e8\u3067\u8a08\u7b97\u3055\u308c\u3001\u623b\u308a\u5024\u306e <code>updates</code> \u3068\u6b21\u306e <code>state</code> \u304c\u8fd4\u3063\u3066\u304d\u307e\u3059\u3002<p></p> <p>\u30c1\u30a7\u30fc\u30f3\u6642\u306e State: - <code>optax.chain(clip, adamw)</code> \u306e\u3088\u3046\u306b\u8907\u6570\u5909\u63db\u3092\u9023\u7d50\u3059\u308b\u3068\u3001\u5404\u5909\u63db\u306e state \u304c\u675f\u306d\u3089\u308c\u305f PyTree \u306b\u306a\u308a\u307e\u3059\uff08\u30af\u30ea\u30c3\u30d4\u30f3\u30b0\u306f\u7121\u72b6\u614b\u306e\u3053\u3068\u304c\u591a\u3044\uff09\u3002 - \u30d1\u30e9\u30e1\u30bf\u306e PyTree \u5f62\u72b6\u3084 dtype \u3092\u5909\u3048\u305f\u5834\u5408\u306f\u3001<code>state = optimizer.init(new_params)</code> \u3067\u518d\u521d\u671f\u5316\u3059\u308b\u306e\u304c\u5b89\u5168\u3067\u3059\u3002\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u306f <code>(params, state, config)</code> \u3092\u307e\u3068\u3081\u3066\u4fdd\u5b58\u30fb\u5fa9\u5143\u3057\u307e\u3059\u3002</p>"},{"location":"optax_basics_ja/#4-chain","title":"4. chain \u3067\u524d\u51e6\u7406\u2192\u6700\u9069\u5316\u306e\u9806\u306b\u7d44\u3080","text":"<ul> <li><code>optax.chain(t1, t2, t3, ...)</code> \u306f\u3001\u5de6\u304b\u3089\u9806\u306b\u5909\u63db\u3092\u9069\u7528\u3057\u307e\u3059\u3002</li> <li>\u4f8b: <code>optax.chain(optax.clip_by_global_norm(clip_norm), optax.adamw(...))</code></li> <li>grads \u306b\u5bfe\u3057\u3066\u307e\u305a\u300c\u30b0\u30ed\u30fc\u30d0\u30eb\u30ce\u30eb\u30e0\u3067\u30af\u30ea\u30c3\u30d7\u300d\u3057\u3001\u305d\u306e\u5f8c\u306b\u300cAdamW \u306e\u30e2\u30e1\u30f3\u30bf\u30e0\u30fb\u91cd\u307f\u6e1b\u8870\u300d\u3092\u9069\u7528\u3059\u308b\u3001\u3068\u3044\u3046\u9806\u5e8f\u3092\u69cb\u6210\u3057\u307e\u3059\u3002</li> </ul> <p>\u30dd\u30a4\u30f3\u30c8: \u30af\u30ea\u30c3\u30d4\u30f3\u30b0\u306a\u3069\u306e\u300c\u52fe\u914d\u524d\u51e6\u7406\u300d\u306f AdamW \u3088\u308a\u524d\u306b\u7f6e\u304f\u306e\u304c\u5b9a\u77f3\u3067\u3059\u3002</p>"},{"location":"optax_basics_ja/#faq-chain-optimizer","title":"\u88dc\u8db3\uff08FAQ\uff09: chain \u306f optimizer \u3092\u201c\u66f8\u304d\u63db\u3048\u308b\u201d\u306e\uff1f","text":"<ul> <li>\u3044\u3044\u3048\u3002<code>optax.chain</code> \u306f\u300c\u65e2\u5b58\u30aa\u30d7\u30c6\u30a3\u30de\u30a4\u30b6\u306e <code>.update</code> \u3092\u5f8c\u304b\u3089\u66f8\u304d\u63db\u3048\u308b\uff08\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u3059\u308b\uff09\u300d\u306e\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002</li> <li>\u8907\u6570\u306e Transform \u3092\u5408\u6210\u3057\u3066\u300c\u65b0\u3057\u3044 GradientTransformation\uff08= <code>init/update</code> \u306e\u30da\u30a2\uff09\u300d\u3092\u4f5c\u308b\u95a2\u6570\u3067\u3059\u3002</li> <li>\u5185\u90e8\u306e\u30a4\u30e1\u30fc\u30b8\uff08\u64ec\u4f3c\u30b3\u30fc\u30c9\uff09:</li> </ul> <pre><code>def chain(*transforms):\n  def init(params):\n    return tuple(t.init(params) for t in transforms)\n\n  def update(updates, state, params=None):\n    # \u6700\u521d\u306e updates \u306f grads\uff08= \u52fe\u914d\uff09\u3092\u60f3\u5b9a\n    new_states = []\n    for t, s in zip(transforms, state):\n      updates, s = t.update(updates, s, params)  # \u5de6\u304b\u3089\u9806\u306b\u524d\u51e6\u7406\u2192\u6700\u9069\u5316\u2026\n      new_states.append(s)\n    return updates, tuple(new_states)\n\n  return GradientTransformation(init=init, update=update)\n</code></pre> <ul> <li>\u3057\u305f\u304c\u3063\u3066\u300coptimizer \u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u300d\u3068\u3044\u3046\u3088\u308a\u3001\u300c1\u30b9\u30c6\u30c3\u30d7\u306e update \u898f\u5247\u3092\u90e8\u54c1\u306e\u9023\u7d50\u3067\u201c\u5b9a\u7fa9\u3059\u308b\u201d\u300d\u30a4\u30e1\u30fc\u30b8\u3067\u3059\u3002</li> <li>\u306a\u304a\u3001<code>update</code> \u306f\u5e38\u306b\u201c1\u30b9\u30c6\u30c3\u30d7\u5206\u201d\u3060\u3051\u8a08\u7b97\u3057\u307e\u3059\u3002\u8907\u6570\u30b9\u30c6\u30c3\u30d7\u9032\u3081\u308b\u306b\u306f <code>fori_loop/scan/while_loop</code> \u306a\u3069\u3067\u30eb\u30fc\u30d7\u3092\u56de\u3057\u307e\u3059\uff08\u00a76 \u3092\u53c2\u7167\uff09\u3002</li> </ul>"},{"location":"optax_basics_ja/#5-adam-adamw-decoupled-weight-decay","title":"5. Adam \u3068 AdamW \u306e\u9055\u3044\uff08decoupled weight decay\uff09","text":"<ul> <li>Adam: \u901a\u5e38\u306e Adam \u306f L2 \u6b63\u5247\u5316\u3092\u52fe\u914d\u306b\u9805\u3068\u3057\u3066\u8db3\u3059\u5f62\u306b\u306a\u308a\u304c\u3061\u3067\u3059\u3002</li> <li>AdamW: \u91cd\u307f\u6e1b\u8870\uff08weight decay\uff09\u3092\u52fe\u914d\u304b\u3089\u5207\u308a\u96e2\u3057\u3066\u9069\u7528\uff08decoupled\uff09\u3002\u3053\u308c\u306b\u3088\u308a\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0\u6319\u52d5\u304c\u5b89\u5b9a\u3057\u3084\u3059\u3044\u3002</li> <li>Optax \u306e <code>adamw(learning_rate, weight_decay, ...)</code> \u306f\u3053\u306e AdamW \u3092\u8fd4\u3057\u307e\u3059\u3002</li> </ul>"},{"location":"optax_basics_ja/#6-jit-fori_loop-scan","title":"6. \u9ad8\u901f\u306b\u8907\u6570\u30b9\u30c6\u30c3\u30d7\u56de\u3059\u6700\u5c0f\u4f8b\uff08JIT + fori_loop / scan\uff09","text":"<p>\u8907\u6570\u30b9\u30c6\u30c3\u30d7\u306e\u6700\u9069\u5316\u3092 JAX \u3067\u9ad8\u901f\u306b\u56de\u3059\u306b\u306f\u3001\u30eb\u30fc\u30d7\u3092 <code>jax.jit</code> \u3067\u4e38\u3054\u3068\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u307e\u3059\u3002\u56fa\u5b9a\u56de\u6570\u306a\u3089 <code>lax.fori_loop</code> \u304b <code>lax.scan</code> \u304c\u4fbf\u5229\u3067\u3059\u3002</p>"},{"location":"optax_basics_ja/#41-fori_loop","title":"4.1 fori_loop \u7248\uff08\u5c65\u6b74\u4e0d\u8981\u30fb\u56fa\u5b9a\u56de\u6570\uff09","text":"<pre><code>import jax, jax.numpy as jnp\nimport optax\n\nopt = optax.adamw(learning_rate=1e-3, weight_decay=1e-4)\n\ndef loss(p):\n  return jnp.sum(p**2)  # \u6700\u5c0f\u5316\u306e\u4f8b\uff08\u6700\u5927\u5316\u306a\u3089 -objective \u3092 loss \u306b\uff09\n\n@jax.jit\ndef train_n_steps(params, state, n_steps: int):\n  def body(i, carry):\n    params, state = carry\n    grads = jax.grad(loss)(params)          # \u6700\u5927\u5316\u306a\u3089 grads = -jax.grad(objective)(params)\n    updates, state = opt.update(grads, state, params)\n    params = optax.apply_updates(params, updates)\n    return (params, state)\n\n  return jax.lax.fori_loop(0, n_steps, body, (params, state))\n\nparams = jnp.zeros((3,))\nstate = opt.init(params)\nparams, state = train_n_steps(params, state, n_steps=1000)\n</code></pre>"},{"location":"optax_basics_ja/#42-scan","title":"4.2 scan \u7248\uff08\u5c65\u6b74\u304c\u5fc5\u8981\u30fb\u56fa\u5b9a\u56de\u6570\uff09","text":"<pre><code>import jax, jax.numpy as jnp\nimport optax\n\nopt = optax.adamw(learning_rate=1e-3, weight_decay=1e-4)\n\ndef loss(p):\n  return jnp.sum(p**2)\n\n@jax.jit\ndef train_scan(params, state, steps: int):\n  def step_fn(carry, _):\n    params, state = carry\n    grads = jax.grad(loss)(params)\n    updates, state = opt.update(grads, state, params)\n    params = optax.apply_updates(params, updates)\n    return (params, state), params  # \u5c65\u6b74\u3068\u3057\u3066 params \u3092\u53ce\u96c6\uff08\u4e0d\u8981\u306a\u3089 None\uff09\n\n  (params, state), traj = jax.lax.scan(step_fn, (params, state), xs=None, length=steps)\n  return params, state, traj  # traj.shape = (steps, *params.shape)\n\nparams = jnp.zeros((3,))\nstate = opt.init(params)\nparams, state, traj = train_scan(params, state, steps=1000)\n</code></pre> <p>\u6ce8\u610f - \u4e0a\u306e\u4f8b\u306f\u300c\u6700\u5c0f\u5316\u300d\u898f\u7d04\u3067\u3059\u3002\u76ee\u7684\u304c\u6700\u5927\u5316\u306a\u3089 <code>loss = lambda p: -objective(p)</code> \u3068\u3059\u308b\u304b\u3001<code>grads = -jax.grad(objective)(params)</code> \u3068\u3057\u3066\u7b26\u53f7\u3092\u53cd\u8ee2\u3057\u3066\u304f\u3060\u3055\u3044\u3002 - \u53cd\u5fa9\u56de\u6570\u304c\u5b9f\u884c\u6642\u306b\u6c7a\u307e\u308b\uff08\u53ce\u675f\u3067\u505c\u6b62\uff09\u5834\u5408\u306f <code>lax.while_loop</code> \u304c\u9069\u5207\u3067\u3059\u3002</p> <p>\u88dc\u8db3: <code>optax.apply_updates(params, updates)</code> \u306f\u672c\u8cea\u7684\u306b\u300c\u8981\u7d20\u3054\u3068\u306e\u52a0\u7b97\u300d\u3067\u3059\uff08PyTree \u540c\u5f62\u306e <code>params + updates</code>\uff09\u3002 updates \u306b\u306f\u5b66\u7fd2\u7387\u30fb\u30e2\u30e1\u30f3\u30bf\u30e0\u30fb\u91cd\u307f\u6e1b\u8870\u30fb\u30af\u30ea\u30c3\u30d4\u30f3\u30b0\u306a\u3069\u306e\u52b9\u679c\u304c\u3059\u3067\u306b\u53cd\u6620\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u30e6\u30fc\u30b6\u5074\u3067\u3055\u3089\u306b\u5b66\u7fd2\u7387\u3092\u639b\u3051\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u5dee\u5206\u3092\u78ba\u8a8d\u3057\u305f\u3044\u5834\u5408\u306f <code>updates</code> \u81ea\u4f53\u3092\u30ed\u30b0\u3059\u308c\u3070 OK \u3067\u3059\u3002</p>"},{"location":"optax_basics_ja/#7-clip_by_global_norm-chain","title":"7. clip_by_global_norm \u3068\u4f75\u7528\uff08chain\uff09","text":"<pre><code>opt = optax.chain(\n    optax.clip_by_global_norm(clip_norm=1.0),\n    optax.adamw(learning_rate=1e-3, weight_decay=1e-4),\n)\nstate = opt.init(params)\nupdates, state = opt.update(grads, state, params)\nparams = optax.apply_updates(params, updates)\n</code></pre> - <code>clip_by_global_norm</code> \u306f\u52fe\u914d\u30d9\u30af\u30c8\u30eb\u5168\u4f53\u306e L2 \u30ce\u30eb\u30e0\u3092\u4e0a\u9650 <code>clip_norm</code> \u306b\u53ce\u3081\u308b\u524d\u51e6\u7406\u3002 - \u305d\u306e\u5f8c\u306b AdamW \u304c\u30e2\u30e1\u30f3\u30bf\u30e0\u3068\u6e1b\u8870\u3092\u52a0\u5473\u3057\u305f\u66f4\u65b0\u3092\u8a08\u7b97\u3057\u307e\u3059\u3002"},{"location":"optax_basics_ja/#8-parameter_estimator_newpy","title":"8. \u672c\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u306e\u904b\u7528\uff08parameter_estimator_new.py\uff09","text":"<ul> <li>\u80cc\u666f: \u300c\u6700\u5927\u5316\u300d\u554f\u984c\u3002\u30d8\u30c3\u30bb\u304c\u8ca0\u5b9a\u3067\u306a\u3044\u5834\u5408\u306f AdamW \u3078\u30d5\u30a9\u30fc\u30eb\u30d0\u30c3\u30af\u3002</li> <li>\u69cb\u6210: <pre><code>adam = optax.adamw(learning_rate=learning_rate, weight_decay=weight_decay)\noptimizer = optax.chain(optax.clip_by_global_norm(clip_norm), adam)\nstate0 = optimizer.init(theta0)\n</code></pre></li> <li>\u53cd\u5fa9\u5185\u306e AdamW \u5206\u5c90: <pre><code># g: objective \u306e\u52fe\u914d\uff08\u4e0a\u6607\u65b9\u5411\u3078\u52d5\u304d\u305f\u3044\uff09\n# Maximization \u306e\u305f\u3081\u3001\u6700\u5c0f\u5316\u898f\u7d04\u306e Optax \u306b\u306f -g \u3092\u6e21\u3059\u306e\u304c\u81ea\u7136\nupdates, state_next = optimizer.update(-g, state, theta)\ntheta_next = optax.apply_updates(theta, updates)\n</code></pre></li> <li>\u3053\u308c\u306b\u3088\u308a\u300cAdamW \u306f\u6700\u5c0f\u5316\u5668\u300d\u3068\u3044\u3046\u898f\u7d04\u3092\u4fdd\u3063\u305f\u307e\u307e\u3001\u76ee\u7684\u306f\u6700\u5927\u5316\uff08\u4e0a\u6607\uff09\u306b\u6574\u5408\u3057\u307e\u3059\u3002</li> </ul> <p>\u88dc\u8db3: - <code>optimizer.update(grads, state, params)</code> \u306e\u7b2c3\u5f15\u6570 <code>params</code> \u306f\u4e00\u90e8\u306e\u5909\u63db\uff08weight decay \u306a\u3069\uff09\u3067\u5fc5\u8981\u3067\u3059\u3002\u5e38\u306b\u6e21\u3057\u3066\u304a\u304f\u306e\u304c\u7121\u96e3\u3067\u3059\u3002 - learning rate / decay / clip \u306e\u5024\u306f\u554f\u984c\u306b\u5fdc\u3058\u3066\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3057\u307e\u3059\u3002Newton \u5206\u5c90\u304c\u5b89\u5b9a\u306a\u3089 AdamW \u5206\u5c90\u306f\u7a00\u306b\u3057\u304b\u4f7f\u308f\u308c\u306a\u3044\u60f3\u5b9a\u3067\u3082\u3001\u6570\u5024\u7684\u5b89\u5168\u6027\u306e\u305f\u3081\u30af\u30ea\u30c3\u30d7\u306f\u6709\u52b9\u3067\u3059\u3002</p>"},{"location":"optax_basics_ja/#9","title":"9. \u3088\u304f\u3042\u308b\u843d\u3068\u3057\u7a74","text":"<ul> <li>\u6700\u5927\u5316\u3067 <code>optimizer.update(g, ...)</code> \u3068\u3057\u3066\u3057\u307e\u3044\u3001\u5b9f\u306f\u300c\u964d\u4e0b\u300d\u3057\u3066\u3044\u308b\u3002</li> <li>\u5bfe\u7b56: <code>optimizer.update(-g, ...)</code> \u306b\u3059\u308b\u304b\u3001loss \u3092 <code>-objective</code> \u306b\u3059\u308b\u3002</li> <li>chain \u306e\u9806\u5e8f\u30df\u30b9</li> <li>\u4f8b: AdamW \u306e\u5f8c\u306b clip \u3092\u7f6e\u304f\u3068\u3001\u30e2\u30e1\u30f3\u30bf\u30e0\u8a08\u7b97\u5f8c\u306e\u66f4\u65b0\u304c\u30af\u30ea\u30c3\u30d7\u3055\u308c\u3001\u6319\u52d5\u304c\u5909\u308f\u308b\u3002</li> <li>state \u306e\u53d6\u308a\u56de\u3057</li> <li><code>state = optimizer.init(params)</code> \u3092\u5fd8\u308c\u305f\u308a\u3001PyTree \u5f62\u72b6\u304c\u5408\u308f\u306a\u3044\u3068\u30a8\u30e9\u30fc\u3002\u30d1\u30e9\u30e1\u30bf\u306e dtype \u5909\u66f4\u6642\u306b\u3082\u6ce8\u610f\u3002</li> </ul>"},{"location":"optax_basics_ja/#10","title":"10. \u53c2\u8003\u30d1\u30bf\u30fc\u30f3\uff08\u6700\u5927\u5316\u554f\u984c\u306e\u3072\u306a\u578b\uff09","text":"<pre><code>opt = optax.chain(\n    optax.clip_by_global_norm(clip_norm),\n    optax.adamw(learning_rate=lr, weight_decay=wd),\n)\n\n@jax.jit\ndef ascend_step(theta, aux, state):\n    def obj(th):\n        return jnp.asarray(objective_fn(th, aux))  # maximize\n    g = jax.grad(obj)(theta)\n    updates, state = opt.update(-g, state, theta)  # \u6700\u5927\u5316\u306a\u306e\u3067 -g\n    theta = optax.apply_updates(theta, updates)\n    return theta, state\n</code></pre> <p>\u3053\u306e\u6700\u5c0f\u30eb\u30fc\u30eb\u3092\u62bc\u3055\u3048\u3066\u304a\u3051\u3070\u3001<code>parameter_estimator_new.py</code> \u306e Optimizer \u69cb\u7bc9\u3068 while_loop \u5185\u3067\u306e\u904b\u7528\u610f\u56f3\u3092\u8aad\u307f\u89e3\u3051\u308b\u306f\u305a\u3067\u3059\u3002</p>"},{"location":"optax_basics_ja/#a-glossary","title":"\u4ed8\u9332A. \u7528\u8a9e\u96c6\uff08Glossary\uff09","text":"<ul> <li>Transform\uff08\u5909\u63db\uff09</li> <li><code>optax.adamw(...)</code> \u3084 <code>optax.clip_by_global_norm(...)</code> \u304c\u8fd4\u3059\u300c\u6700\u9069\u5316\u51e6\u7406\u306e\u90e8\u54c1\u300d\u3002</li> <li><code>init/ update</code> \u3092\u63d0\u4f9b\u3057\u3001\u9023\u7d50\uff08<code>optax.chain</code>\uff09\u3057\u3066\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u3092\u69cb\u7bc9\u3067\u304d\u308b\u3002</li> <li>Optimizer State\uff08\u6700\u9069\u5316\u5668\u306e\u72b6\u614b\uff09</li> <li>\u30e2\u30e1\u30f3\u30bf\u30e0\u3001\u4e8c\u4e57\u5e73\u5747\u3001\u91cd\u307f\u6e1b\u8870\u306e\u5185\u90e8\u7d71\u8a08\u306a\u3069\u3092\u4fdd\u6301\u3059\u308b PyTree\u3002</li> <li><code>state = optimizer.init(params)</code> \u3067\u4f5c\u6210\u3057\u3001<code>updates, state = optimizer.update(...)</code> \u3067\u6bce\u30b9\u30c6\u30c3\u30d7\u66f4\u65b0\u3002</li> <li>Updates\uff08\u66f4\u65b0\u91cf\u306e PyTree\uff09</li> <li><code>update</code> \u304c\u8fd4\u3059\u300c\u30d1\u30e9\u30e1\u30bf\u3068\u540c\u5f62\u306e\u5dee\u5206\u300d\u3002<code>optax.apply_updates(params, updates)</code> \u3067\u9069\u7528\u3002</li> <li>\u5909\u63db\u306e\u7d44\u307f\u5408\u308f\u305b\uff08clip\u2192adamw \u306a\u3069\uff09\u3092\u7d4c\u305f\u6700\u7d42\u7684\u306a\u66f4\u65b0\u5024\u3002</li> <li>Params\uff08\u30d1\u30e9\u30e1\u30bf\uff09</li> <li>\u5b66\u7fd2\u5bfe\u8c61\u306e PyTree\u3002<code>init/ update</code> \u53cc\u65b9\u306b\u5f62\u72b6\u304c\u5fc5\u8981\u3002</li> <li>Chain\uff08\u9023\u7d50\uff09</li> <li><code>optax.chain(t1, t2, ...)</code> \u3067\u5909\u63db\u3092\u5de6\u304b\u3089\u9806\u306b\u9069\u7528\u3002\u524d\u51e6\u7406\u2192\u6700\u9069\u5316\u306e\u9806\u3092\u5b88\u308b\u306e\u304c\u5b9a\u77f3\u3002</li> <li>Learning rate\uff08\u5b66\u7fd2\u7387\uff09</li> <li>\u66f4\u65b0\u5e45\u306e\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0\u3002\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\uff08<code>optax.cosine_decay_schedule</code> \u7b49\uff09\u3068\u7d44\u307f\u5408\u308f\u305b\u53ef\u3002</li> <li>Weight decay\uff08\u91cd\u307f\u6e1b\u8870\uff09</li> <li>\u30d1\u30e9\u30e1\u30bf\u306b\u76f4\u63a5\u306e\u6e1b\u8870\u3092\u4e0e\u3048\u308b\u6b63\u5247\u5316\u3002AdamW \u306f\u52fe\u914d\u304b\u3089\u72ec\u7acb\u306b\u9069\u7528\uff08decoupled\uff09\u3002</li> <li>Clipping\uff08\u30af\u30ea\u30c3\u30d4\u30f3\u30b0\uff09</li> <li>\u52fe\u914d/\u66f4\u65b0\u306e\u30ce\u30eb\u30e0\u3092\u4e0a\u9650\u306b\u53ce\u3081\u308b\u524d\u51e6\u7406\u3002<code>clip_by_global_norm</code> \u306f\u5168\u4f53 L2 \u30ce\u30eb\u30e0\u57fa\u6e96\u3002</li> </ul>"},{"location":"optax_basics_ja/#b-update-1adamw","title":"\u4ed8\u9332B. \u300cupdate \u306f1\u30b9\u30c6\u30c3\u30d7\u3060\u3051\u300d\u306e\u6ce8\u610f\u70b9\uff08AdamW\u306f\u53cd\u5fa9\u6cd5\u3060\u304c\u9ed2\u7bb1\u3067\u306f\u306a\u3044\uff09","text":"<ul> <li><code>optimizer.update(grads, state, params)</code> \u306f\u3001\u305d\u306e\u547c\u3073\u51fa\u30571\u56de\u3076\u3093\u306e\u300c\u66f4\u65b0\u91cf\uff08updates\uff09\u300d\u3068\u300c\u6b21\u306e\u72b6\u614b\uff08state\uff09\u300d\u3092\u8fd4\u3057\u307e\u3059\u3002\u8907\u6570\u56de\u3076\u3093\u3092\u307e\u3068\u3081\u3066\u9069\u7528\u3059\u308b\u3082\u306e\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002</li> <li>Adam/AdamW \u306f\u53cd\u5fa9\u6cd5\u3067\u3059\u304c\u3001\u5404\u53cd\u5fa9\u3067\u306e\u201c1\u30b9\u30c6\u30c3\u30d7\u306e\u66f4\u65b0\u898f\u5247\u201d\u3092\u5b9a\u3081\u3066\u3044\u307e\u3059\u3002\u3088\u3063\u3066\u3001<code>update</code> \u306e1\u56de\u547c\u3073\u51fa\u3057 = 1\u30b9\u30c6\u30c3\u30d7\u66f4\u65b0\u306e\u8a08\u7b97\u3067\u3059\u3002</li> <li>\u8907\u6570\u30b9\u30c6\u30c3\u30d7\u9032\u3081\u305f\u3044\u5834\u5408\u306f\u3001\u30eb\u30fc\u30d7\uff08<code>lax.fori_loop</code> / <code>lax.scan</code> / <code>lax.while_loop</code>\uff09\u3067\u8907\u6570\u56de <code>update \u2192 apply_updates</code> \u3092\u56de\u3057\u3066\u304f\u3060\u3055\u3044\uff08\u00a74 \u53c2\u7167\uff09\u3002</li> <li><code>optax.chain(...)</code> \u306f\u300c\u524d\u51e6\u7406\u2192\u6700\u9069\u5316\u300d\u306e\u5408\u6210\u3092\u201c1\u30b9\u30c6\u30c3\u30d7\u306e\u4e2d\u3067\u9806\u306b\u9069\u7528\u201d\u3057\u3066\u3044\u308b\u3060\u3051\u3067\u3001\u8907\u6570\u56de\u306e\u53cd\u5fa9\u304c\u307e\u3068\u3081\u3066\u5b9f\u884c\u3055\u308c\u308b\u308f\u3051\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002</li> </ul>"},{"location":"optax_basics_ja/#c-optimizer-state","title":"\u4ed8\u9332C. Optimizer State \u306e\u8a73\u7d30\u5f0f\uff08\u53c2\u8003\uff09","text":"<p>Optimizer State \u306f\u3001\u5404 transform \u304c\u300c\u66f4\u65b0\u3092\u9069\u5fdc\u7684\u306b\u6c7a\u3081\u308b\u305f\u3081\u306b\u5fc5\u8981\u306a\u5185\u90e8\u7d71\u8a08\u300d\u3092\u4fdd\u6301\u3059\u308b PyTree \u3067\u3059\u3002AdamW \u306e\u5834\u5408\u3001\u4ee3\u8868\u7684\u306b\u306f\u4ee5\u4e0b\u304c\u542b\u307e\u308c\u307e\u3059\u3002</p> <ul> <li>m\uff08\u4e00\u6b21\u30e2\u30fc\u30e1\u30f3\u30c8\uff09: \u52fe\u914d\u306e\u79fb\u52d5\u5e73\u5747\uff08\u30e2\u30e1\u30f3\u30bf\u30e0\uff09</li> <li>v\uff08\u4e8c\u6b21\u30e2\u30fc\u30e1\u30f3\u30c8\uff09: \u52fe\u914d\u4e8c\u4e57\u306e\u79fb\u52d5\u5e73\u5747</li> <li>count: \u53cd\u5fa9\u30ab\u30a6\u30f3\u30c8\uff08\u30d0\u30a4\u30a2\u30b9\u88dc\u6b63\u306b\u4f7f\u3046\uff09</li> </ul> <p>\u5178\u578b\u7684\u306a\u66f4\u65b0\u306e\u6d41\u308c\uff08\u6700\u5c0f\u5316\u898f\u7d04\uff09: </p><pre><code>m_t = \u03b21 * m_{t-1} + (1-\u03b21) * g_t\nv_t = \u03b22 * v_{t-1} + (1-\u03b22) * (g_t \u2299 g_t)\nm\u0302_t = m_t / (1 - \u03b21^t)\nv\u0302_t = v_t / (1 - \u03b22^t)\nupdates = - lr * m\u0302_t / (sqrt(v\u0302_t) + \u03b5)   # \u6700\u5c0f\u5316\u306e\u964d\u4e0b\u65b9\u5411\n# AdamW \u306e decoupled weight decay \u306f\u52fe\u914d\u3068\u306f\u72ec\u7acb\u306b params \u306b\u6e1b\u8870\u3092\u9069\u7528\nparams_next = params + updates  -  lr * weight_decay * params\n</code></pre> Optax \u5b9f\u88c5\u3067\u306f\u3001\u3053\u308c\u3089\u306e\u51e6\u7406\u304c <code>optimizer.update(grads, state, params)</code> \u306e\u4e2d\u3067\u884c\u308f\u308c\u3001\u623b\u308a\u5024\u306e <code>updates</code> \u3068\u6b21\u306e <code>state</code> \u304c\u8fd4\u3055\u308c\u307e\u3059\u3002<p></p> <p>\u30c1\u30a7\u30fc\u30f3\u6642\u306e State: - <code>optax.chain(clip, adamw)</code> \u306e\u3088\u3046\u306b\u8907\u6570\u5909\u63db\u3092\u9023\u7d50\u3059\u308b\u3068\u3001\u5404\u5909\u63db\u306e state \u304c\u675f\u306d\u3089\u308c\u305f PyTree \u306b\u306a\u308a\u307e\u3059\u3002 - \u4f8b\u3048\u3070 <code>clip_by_global_norm</code> \u306f\u300c\u7121\u72b6\u614b\u300d\u306e\u3053\u3068\u304c\u591a\u304f\u3001\u4e00\u65b9\u3067 <code>adamw</code> \u306f <code>m/v/count</code> \u7b49\u3092\u6301\u3061\u307e\u3059\u3002</p> <p>\u518d\u521d\u671f\u5316\u30fb\u30ea\u30b9\u30c8\u30a2\u306e\u6307\u91dd: - \u30d1\u30e9\u30e1\u30bf\u306e PyTree \u5f62\u72b6\u3084 dtype \u3092\u5909\u3048\u305f\u5834\u5408\u306f\u3001<code>state = opt.init(new_params)</code> \u3067\u518d\u521d\u671f\u5316\u3059\u308b\u306e\u304c\u5b89\u5168\u3067\u3059\u3002 - \u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u308b\u5834\u5408\u3001<code>(params, state, opt_config)</code> \u3092\u30bb\u30c3\u30c8\u3067\u4fdd\u5b58\u30fb\u5fa9\u5143\u3057\u307e\u3059\u3002</p> <p>JAX \u7684\u306a\u4e0d\u5909\u6027\u3068 best practices: - state \u306f\u30a4\u30df\u30e5\u30fc\u30bf\u30d6\u30eb\u306b\u6271\u3044\u3001\u6bce\u30b9\u30c6\u30c3\u30d7 <code>updates, state = opt.update(...); params = apply_updates(...)</code> \u3067\u65b0\u3057\u3044\u5024\u3092\u53d7\u3051\u53d6\u308a\u307e\u3059\u3002 - while_loop/scan \u5185\u306e carry \u3068\u3057\u3066 <code>(params, state)</code> \u3092\u56de\u3059\u3068 JIT \u3067\u9ad8\u901f\u5316\u3067\u304d\u307e\u3059\uff08\u00a74 \u53c2\u7167\uff09\u3002 - \u6700\u5927\u5316\u3067\u306f <code>grads</code> \u306e\u7b26\u53f7\u3092\u53cd\u8ee2\u3057\u3066\u6e21\u3059\uff08<code>updates</code> \u81ea\u4f53\u306f\u201c\u964d\u4e0b\u201d\u898f\u7d04\u3067\u751f\u6210\u3055\u308c\u308b\u305f\u3081\uff09\u3002</p> <p>\u88dc\u8db3: Stateless \u306a transform - \u30af\u30ea\u30c3\u30d4\u30f3\u30b0\u3084\u5358\u7d14\u306a\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0\u306f state \u3092\u6301\u305f\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u306e\u5834\u5408\u3067\u3082 <code>chain</code> \u306e\u4e2d\u3067\u4ed6\u306e\u5909\u63db\u306e state \u3068\u4e00\u7dd2\u306b\u6271\u308f\u308c\u307e\u3059\u3002</p>"},{"location":"parameter_estimator_usage/","title":"Parameter Estimator Usage","text":""},{"location":"parameter_estimator_usage/#api","title":"\u63a8\u5b9a\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u306e\u5229\u7528\u30ac\u30a4\u30c9\uff08\u73fe\u884cAPI\uff09","text":"<p>\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306f\u3001\u73fe\u884c\u306e JAX \u30cd\u30a4\u30c6\u30a3\u30d6\u63a8\u5b9a API \u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002</p> <p>\u542b\u307e\u308c\u308b\u6a5f\u80fd\uff08\u629c\u7c8b\uff09 - \u30cb\u30e5\u30fc\u30c8\u30f3\u4e0a\u6607\u306e1\u30b9\u30c6\u30c3\u30d7/\u53ce\u675f\u30bd\u30eb\u30d0\uff08\u5883\u754c\u6295\u5f71\u3064\u304d\uff09 - BlackJAX NUTS \u306b\u3088\u308b\u4e8b\u5f8c\u66f4\u65b0\u306e1\u30b9\u30c6\u30c3\u30d7\uff08unary logprob\uff09</p> <pre><code>from degenerate_diffusion.estimation.parameter_estimator_new import (\n    build_one_step_ascent,\n    build_newton_ascent_solver,\n    build_bayes_transition,\n)\n</code></pre>"},{"location":"parameter_estimator_usage/#m","title":"M\u63a8\u5b9a\uff08\u6700\u5927\u5316\uff09","text":"<p>\u76ee\u7684\u95a2\u6570: <code>objective(theta, aux) -&gt; scalar</code>\uff08\u6700\u5927\u5316\uff09\u3002</p> <pre><code>import jax\nimport jax.numpy as jnp\n\nobjective = lambda th, aux: -0.5 * jnp.sum((th - aux[\"mu\"]) ** 2)\nbounds = [(-jnp.inf, jnp.inf)] * 3\n\nstep = build_one_step_ascent(objective, bounds, damping=0.5)\nsolve = build_newton_ascent_solver(objective, bounds, tol=1e-8, damping=1.0)\n\ntheta0 = jnp.zeros(3)\naux = {\"mu\": jnp.ones(3)}\n\ntheta1 = step(theta0, aux)\nthetahat = solve(theta0, aux)\n</code></pre> <p>\u30dd\u30a4\u30f3\u30c8 - \u30d8\u30c3\u30bb\u5b89\u5b9a\u5316\u306f\u6700\u5927\u5316\u306e\u305f\u3081 <code>-eps * I</code> \u3092\u4f7f\u7528 - AdamW \u30d5\u30a9\u30fc\u30eb\u30d0\u30c3\u30af\u306f\u6700\u5927\u5316\u306a\u306e\u3067 <code>-grad</code> \u3092\u6700\u9069\u5316 - \u5883\u754c\u306f <code>clip</code> \u306b\u3088\u308a\u5c04\u5f71</p>"},{"location":"parameter_estimator_usage/#bnuts","title":"B\u63a8\u5b9a\uff08NUTS \u4e00\u6b69\uff09","text":"<p>BlackJAX NUTS \u306e1\u30b9\u30c6\u30c3\u30d7\u9077\u79fb\u3092\u30d3\u30eb\u30c0\u30fc\u3067\u69cb\u7bc9\u3057\u307e\u3059\u3002logprob \u306f unary\uff08<code>theta</code> \u306e\u307f\uff09\u3067\u3059\u3002aux \u3092\u4f7f\u3046\u5834\u5408\u306f\u3001\u4e8b\u524d\u306b\u9589\u3058\u3066\u304b\u3089\u6e21\u3057\u307e\u3059\u3002</p> <pre><code>import jax\nimport jax.numpy as jnp\n\ndef logprob(theta: jax.Array, aux) -&gt; jax.Array:\n    d = theta - aux[\"mean\"]\n    return -0.5 * (d @ (aux[\"inv_cov\"] @ d))\n\naux_fixed = {\"mean\": jnp.array([1.0]), \"inv_cov\": jnp.eye(1)}\nclosed = lambda th: logprob(th, aux_fixed)\n\nstep = build_bayes_transition(closed, step_size=0.2, max_num_doublings=6)\n\nkey = jax.random.PRNGKey(0)\nth0 = jnp.array([0.0])\nth1, key = step(th0, key)\n</code></pre> <p>\u6ce8\u610f - <code>num_integration_steps</code> \u306f\u4f7f\u308f\u305a\u3001NUTS \u306e\u6728\u306e\u6df1\u3055\u306f <code>max_num_doublings</code> \u3092\u6307\u5b9a - <code>inverse_mass_matrix</code> \u3092\u7701\u7565\u3059\u308b\u3068 <code>ones_like(theta)</code> \u304c\u30c7\u30d5\u30a9\u30eb\u30c8 - \u5185\u90e8\u3067 API \u5dee\u5206\u306b\u5bfe\u5fdc\uff08\u53e4\u3044 BlackJAX \u3067\u3082\u52d5\u4f5c\uff09</p>"},{"location":"parameter_estimator_usage/#mb","title":"\u4ea4\u4e92\u63a8\u5b9a\uff08M/B\uff09","text":"<p><code>lax.scan</code>\u30fb<code>lax.fori_loop</code> \u3067 M/B \u3092\u4ea4\u4e92\u306b\u547c\u3073\u5206\u3051\u3089\u308c\u307e\u3059\u3002\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u3084\u30d6\u30ed\u30c3\u30af\u66f4\u65b0\u306e\u8a73\u7d30\u306f\u8a2d\u8a08\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>"},{"location":"uv_workspace_setup/","title":"UV Workspace Setup","text":""},{"location":"uv_workspace_setup/#uv","title":"uv \u3068\u4eee\u60f3\u74b0\u5883\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u624b\u9806\u30e1\u30e2","text":""},{"location":"uv_workspace_setup/#_1","title":"\u80cc\u666f","text":"<ul> <li>\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306f <code>/Users/yanoshouta/dev/degenerate-diffusion</code>\uff08Python 3.11\uff09\u3002</li> <li>\u4ee5\u524d <code>/Users/yanoshouta/degenerate-diffusion/.venv</code> \u306b\u65e7\u74b0\u5883\u304c\u5b58\u5728\u3057\u3001\u305d\u3053\u3092\u4f7f\u3044\u7d9a\u3051\u3066\u3044\u305f\u3002</li> <li><code>uv</code> \u306f \"\u30ab\u30ec\u30f3\u30c8\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u76f4\u4e0b\u306e .venv\" \u3092\u524d\u63d0\u306b\u3059\u308b\u305f\u3081\u3001\u74b0\u5883\u304c\u305a\u308c\u3066\u3044\u308b\u3068\u8b66\u544a\u304c\u51fa\u308b\u3002</li> </ul>"},{"location":"uv_workspace_setup/#1-venv","title":"1. \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u76f4\u4e0b\u306b <code>.venv</code> \u3092\u4f5c\u6210","text":"<pre><code>cd /Users/yanoshouta/dev/degenerate-diffusion\nuv sync            # .venv \u304c\u4f5c\u6210\u3055\u308c\u3001\u4f9d\u5b58\u95a2\u4fc2\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\nsource .venv/bin/activate\n</code></pre> <p>\u203b Windows \u7528\u306e <code>activate.bat</code> \u3092 macOS \u3067\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3002<code>source .venv/bin/activate</code> \u3067\u5341\u5206\u3002</p>"},{"location":"uv_workspace_setup/#2-import","title":"2. \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092 \"import \u53ef\u80fd\" \u306b\u3059\u308b","text":""},{"location":"uv_workspace_setup/#uv-add-uv-pip-install-e","title":"\u306a\u305c <code>uv add .</code> \u3084 <code>uv pip install -e .</code> \u3092\u4f7f\u308f\u306a\u3044\u306e\u304b","text":"<ul> <li><code>uv add .</code> \u306f \"\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u81ea\u8eab (<code>degenerate-diffusion</code>) \u3092\u4f9d\u5b58\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u3057\u3066\u8ffd\u52a0\" \u3057\u3088\u3046\u3068\u3059\u308b\u305f\u3081\u3001\u81ea\u5df1\u4f9d\u5b58\u3067\u5f3e\u304b\u308c\u308b\u3002</li> <li><code>uv pip install -e .</code> \u306f editable install \u3092\u8a66\u307f\u308b\u304c\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5236\u9650\u74b0\u5883\u3067\u306f\u5931\u6557\u3059\u308b\u3053\u3068\u304c\u3042\u308b\u3002</li> </ul>"},{"location":"uv_workspace_setup/#_2","title":"\u73fe\u72b6\u306e\u89e3\u6c7a\u7b56","text":"<p><code>src</code> \u30ec\u30a4\u30a2\u30a6\u30c8\u3068 <code>pyproject.toml</code> \u306e\u8a2d\u5b9a\u306b\u3088\u308a\u3001<code>uv sync</code> \u3067\u30ed\u30fc\u30ab\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u81ea\u52d5\u7684\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\u3002\u3053\u306e\u305f\u3081\u8ffd\u52a0\u306e <code>.pth</code> \u30d5\u30a1\u30a4\u30eb\u306f\u4e0d\u8981\u3002</p> <p>\u53c2\u8003\u3068\u3057\u3066 <code>pyproject.toml</code> \u306e\u6307\u5b9a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002 </p><pre><code>[tool.setuptools.packages.find]\nwhere = [\"src\"]\ninclude = [\"degenerate_diffusion*\"]\nexclude = [\"old*\", \"__pycache__\"]\n\n[build-system]\nrequires = [\"setuptools&gt;=65\", \"wheel\"]\nbuild-backend = \"setuptools.build_meta\"\n</code></pre><p></p>"},{"location":"uv_workspace_setup/#3","title":"3. \u4f9d\u5b58\u95a2\u4fc2\u306e\u66f4\u65b0\uff08\u53c2\u8003\uff09","text":"<ul> <li>\u4f9d\u5b58\u3092\u8ffd\u52a0\u3057\u305f\u3044\u5834\u5408\u306f <code>uv add &lt;package&gt;</code>\uff08<code>&lt;package&gt;</code> \u306f PyPI \u306e\u540d\u524d\uff09\u3002</li> <li>\u81ea\u5206\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u3042\u3048\u3066\u4f9d\u5b58\u3068\u3057\u3066\u5165\u308c\u308b\u5fc5\u8981\u306f\u306a\u3044\u3002</li> <li>\u4eee\u60f3\u74b0\u5883\u5727\u7e2e\u3084\u524a\u9664\u306f <code>rm -rf .venv</code> \u3067\u884c\u3044\u3001\u518d\u69cb\u7bc9\u306f <code>uv sync</code>\u3002</li> </ul>"},{"location":"uv_workspace_setup/#4","title":"4. \u7d50\u5c40\u3069\u3046\u4f7f\u3046\u304b","text":"<pre><code>cd /Users/yanoshouta/dev/degenerate-diffusion\nuv sync                         # \u307e\u3060\u306a\u3089\u4eee\u60f3\u74b0\u5883\u3092\u4f5c\u308b\nsource .venv/bin/activate\n# \u2191 \u4ee5\u964d\u306f\u3053\u306e\u30b7\u30a7\u30eb\u3067\u4f5c\u696d\n\n# \u52d5\u4f5c\u78ba\u8a8d\npython -c \"import degenerate_diffusion; print(degenerate_diffusion.__file__)\"\n</code></pre> <p>\u3053\u308c\u3067 JAX \u30b3\u30fc\u30c9\u3092\u7d76\u5bfe\u30a4\u30f3\u30dd\u30fc\u30c8\u3067\u5229\u7528\u3067\u304d\u3001Ruff \u306e\u8b66\u544a\uff08\u76f8\u5bfe\u30a4\u30f3\u30dd\u30fc\u30c8\uff09\u3082\u56de\u907f\u3067\u304d\u308b\u3002\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5236\u9650\u4e0b\u3067\u3082\u7de8\u96c6\u5185\u5bb9\u304c\u5373\u6642\u53cd\u6620\u3055\u308c\u3001\u958b\u767a\u4f53\u9a13\u304c\u30b7\u30f3\u30d7\u30eb\u306b\u306a\u308b\u3002</p>"}]}